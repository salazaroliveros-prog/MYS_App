<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WM | Control Financiero</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="css/common-responsive.css">
    <style>
        :root { --p: #00447C; --s: #F0F4F8; --a: #FFB300; --w: #FFFFFF; --danger: #dc3545; --success: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--s); margin: 0; }
        header { background: var(--p); color: var(--w); padding: 20px; text-align: center; border-bottom: 5px solid var(--a); display:flex; align-items:center; gap:12px; justify-content:center; }
        header img { height: 60px; max-width:100%; width:auto; margin-right: 12px; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--w); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-ingreso { background: var(--success); }
        .btn-gasto { background: var(--danger); }
        .btn-nav { background: var(--p); width: 100%; justify-content: center; margin-top: 10px; }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .alerta { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid #ffeeba; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
        .progress-container { margin-top: 20px; background: #eee; border-radius: 10px; height: 25px; width: 100%; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: bold; }
        .bar-ingresos { background: var(--success); }
        .bar-gastos { background: var(--danger); margin-top: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-box { padding: 10px; border-radius: 5px; border: 1px solid #ddd; text-align: center; }
        /* Responsive adjustments */
        .header-actions { display:flex; gap:8px; align-items:center; }
        @media (max-width: 640px) {
            header { flex-direction: column; align-items: flex-start; padding: 12px; }
            header img { height: 44px; }
            header h1 { font-size: 1.05rem; }
            header p { font-size: 0.75rem; }
            .btn { padding: 8px 10px; font-size: 0.9rem; }
            .btn-nav { padding: 10px; font-size: 0.95rem; }
            .header-actions { width:100%; justify-content: flex-end; margin-top:8px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            table, th, td { font-size: 0.85rem; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="wm_toast.js"></script>
</head>
    <body onload="inicializar()">
    <header>
        <img src="logo.png" alt="Logo CONSTRUCTORA WM/M&S">
        <div style="text-align:left;">
            <h1 style="margin:0;">SOFTCON-MYS-CONSTRU-WM</h1>
            <p style="margin:4px 0 0; font-style:italic; opacity:0.95;">"CONSTRUYENDO TU FUTURO" - Panel de Control</p>
        </div>
        <div style="margin-left:12px; display:flex; gap:8px; align-items:center;">
            <button onclick="location.href='proyectos.html'" title="Abrir Proyectos" style="background:var(--a); border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; color:#08121a"><i class="fas fa-folder-open"></i> Proyectos</button>
                        <div class="wm-tooltip">
                            <button id="compactToggleIndex" onclick="toggleCompactIndex()" title="Vista Compacta" style="background:var(--p); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700;">üóÇÔ∏è Compacta</button>
                            <div class="wm-tooltip-text">Vista Compacta: oculta columnas secundarias para pantallas peque√±as y permite desplazamiento horizontal. Pulsa para alternar localmente.</div>
                        </div>
                        <div class="wm-tooltip">
                            <button id="globalCompactBtnIndex" class="compact-toggle-global" onclick="syncCompactGlobal()" title="Sincronizar Compacta en todas las p√°ginas">üåê Compacta Global</button>
                            <div class="wm-tooltip-text">Sincroniza la vista compacta en todas las p√°ginas del sitio. Las tablas nuevas tambi√©n recibir√°n el estilo.</div>
                        </div>
                        <div class="wm-tooltip">
                            <button id="configCompactIndex" class="compact-toggle-global" onclick="openCompactConfig()">‚öôÔ∏è Config</button>
                            <div class="wm-tooltip-text">Configurar qu√© columnas se ocultan en la Vista Compacta para esta p√°gina.</div>
                        </div>
                        </div>
        </div>
    </header>
    <div class="container">
        <div id="seccionAlertas"></div>
        <div class="dashboard-grid">
            <div class="card">
                <h3>üí∏ Registrar Movimiento</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-ingreso" onclick="configForm('INGRESO')"><i class="fas fa-plus-circle"></i> INGRESO</button>
                    <button class="btn btn-gasto" onclick="configForm('GASTO')"><i class="fas fa-minus-circle"></i> GASTO</button>
                </div>
                <form id="formFinanzas">
                    <input type="hidden" id="tipoMovimiento" value="INGRESO">
                    <label for="selectProyecto">Seleccionar Proyecto:</label>
                    <select id="selectProyecto" required aria-label="Seleccionar Proyecto" title="Seleccionar Proyecto"></select>
                    <label>Categor√≠a:</label>
                    <select id="categoria" onchange="mostrarCamposExtra()" title="Categor√≠a">
                        <option value="anteproyecto">Anteproyecto / Planos</option>
                        <option value="material">Materiales</option>
                        <option value="mano_obra">Mano de Obra</option>
                        <option value="herramienta">Herramienta y Equipo (Renta)</option>
                        <option value="subcontrato">Sub-Contrato</option>
                    </select>
                    <input type="text" id="desc" placeholder="Descripci√≥n (Ej: Pago Planos de Registro)" required>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="cant" placeholder="Cantidad" oninput="calcTotal()" required>
                        <input type="number" id="pu" placeholder="Costo Unit." oninput="calcTotal()" required>
                    </div>
                    <input type="text" id="totalMov" placeholder="Total" readonly style="background:#eee; font-weight:bold;">
                    <div id="extras" class="hidden">
                        <input type="text" id="proveedor" placeholder="Proveedor / Contratista">
                        <label>Fecha Inicio/Vence:</label>
                        <input type="date" id="fechaFin">
                    </div>
                    <button type="button" class="btn btn-nav" style="background:var(--a)" onclick="guardarMovimiento()">
                        <i class="fas fa-save"></i> GUARDAR Y SINCRONIZAR
                    </button>
                </form>
            </div>
            <div class="card">
                <h3>üöÄ Accesos R√°pidos</h3>
                <div style="display:flex; gap:8px; flex-direction:column;">
                    <button class="btn btn-nav" onclick="location.href='visita_campo.html'"><i class="fas fa-map-marker-alt"></i> VISITA DE CAMPO</button>
                    <button class="btn btn-nav" onclick="location.href='proyectos.html'"><i class="fas fa-folder-open"></i> PROYECTOS (Historial)</button>
                    <button class="btn btn-nav" onclick="location.href='calculadora.html'"><i class="fas fa-calculator"></i> CALCULADORA (Presupuestos)</button>
                </div>
                <hr>
                <h3>üìä Estado de Proyecto</h3>
                <div id="resumenFinanciero">
                    <div class="card">
                        <h3>üìä Balance de Proyecto: <span id="nombreProyActivo">---</span></h3>
                        <select id="filtroProyectoBalance" onchange="renderizarBalance()" style="margin-bottom:15px;" title="Filtro de Proyecto para Balance"></select>
                        <div id="visualBalance">
                            <label>Cobrado al Cliente (Ingresos vs Presupuesto):</label>
                            <div class="progress-container">
                                <div id="progresoIngresos" class="progress-bar bar-ingresos" style="width: 0%">0%</div>
                            </div>
                            <label style="margin-top:15px; display:block;">Ejecuci√≥n de Gasto (Gastos vs Presupuesto):</label>
                            <div class="progress-container">
                                <div id="progresoGastos" class="progress-bar bar-gastos" style="width: 0%">0%</div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <small>Saldo en Caja</small><br>
                                    <strong id="saldoCaja" style="color:var(--p)">Q 0.00</strong>
                                </div>
                                <div class="stat-box">
                                    <small>Pendiente de Cobro</small><br>
                                    <strong id="pendienteCobro" style="color:var(--danger)">Q 0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>üìÑ √öltimos Movimientos</h3>
            <div style="overflow-x:auto;">
                <table id="tablaFinanzas">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Proyecto</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoFinanzas"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container" style="max-width:1200px; margin-top:10px;">
        <div class="card" style="margin-bottom:16px;">
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1; min-width:180px;">
                    <div class="card" style="padding:12px; background:#f7fbff;">
                        <small>Presupuesto</small>
                        <div style="font-size:1.4em; font-weight:700; color:var(--p);" id="kpiPresupuesto">Q 0.00</div>
                    </div>
                </div>
                <div style="flex:1; min-width:180px;">
                    <div class="card" style="padding:12px; background:#eefaf3;">
                        <small>Cobrado</small>
                        <div style="font-size:1.4em; font-weight:700; color:var(--success);" id="kpiCobrado">Q 0.00</div>
                    </div>
                </div>
                <div style="flex:1; min-width:180px;">
                    <div class="card" style="padding:12px; background:#fff6f6;">
                        <small>Gastado</small>
                        <div style="font-size:1.4em; font-weight:700; color:var(--danger);" id="kpiGastado">Q 0.00</div>
                    </div>
                </div>
                <div style="flex:1; min-width:180px;">
                    <div class="card" style="padding:12px; background:#fffdfa;">
                        <small>Margen</small>
                        <div style="font-size:1.4em; font-weight:700; color:#333;" id="kpiMargen">Q 0.00</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <label style="font-size:0.9em; color:#666;">Desde:</label>
                    <input type="date" id="startDateFilter" title="Fecha inicio filtro" />
                    <label style="font-size:0.9em; color:#666;">Hasta:</label>
                    <input type="date" id="endDateFilter" title="Fecha fin filtro" />
                    <button id="btnFiltrar" onclick="renderizarBalance()" style="background:var(--p); color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">Filtrar</button>
                    <button id="btnLimpiarFiltro" onclick="limpiarFiltro()" style="background:#6c757d; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">Limpiar</button>
                </div>
            </div>
            <div style="margin-top:8px;">
                <canvas id="chartFinanzas" height="120"></canvas>
            </div>
        </div>
        <div class="card" style="border-top: 5px solid var(--p); margin-top: 20px;">
            <button onclick="generarCierreProyecto()" class="btn btn-nav" style="background: var(--p);">
                <i class="fas fa-file-invoice-dollar"></i> GENERAR CIERRE Y RENTABILIDAD FINAL
            </button>
            <div id="informeCierre" class="hidden" style="margin-top:20px; padding:15px; background: #fdfdfd; border: 1px solid #ccc;">
                <h2 style="text-align:center; color: var(--p);">INFORME DE CIERRE WM</h2>
                <p id="fechaCierre" style="text-align:center; font-size:0.8em;"></p>
                <hr>
                <div id="detalleCierre"></div>
                <canvas id="graficoCierre" style="max-height:200px; margin-top:15px;"></canvas>
            </div>
        </div>
    </div>
    <script>
        // load shared script for global sync
        (function(){ var s=document.createElement('script'); s.src='js/common-responsive.js'; document.head.appendChild(s); })();
        // Consolidated JS: cargarProyectos, renderizarBalance, KPIs, movimientos, cierre
        // Currency helpers
        function formatCurrency(value, decimals = 2) {
            const num = Number(value) || 0;
            try { return 'Q ' + num.toLocaleString('es-GT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
            catch(e) { return 'Q ' + num.toFixed(decimals); }
        }
        function parseCurrency(str) {
            if (str === null || str === undefined) return NaN;
            let s = String(str).trim(); s = s.replace(/Q|\s|\u00A0/g,''); s = s.replace(/[^0-9.,-]/g,'');
            if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) s = s.replace(/\./g,'').replace(/,/g,'.');
            else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) s = s.replace(/,/g,'.');
            const n = Number(s); return isNaN(n) ? NaN : n;
        }

        // Compact toggle for tablaFinanzas
        function toggleCompactIndex() {
            const tbl = document.getElementById('tablaFinanzas');
            const btn = document.getElementById('compactToggleIndex');
            if (!tbl) return;
            tbl.classList.toggle('compact-view');
            if (btn) btn.classList.toggle('active');
            try { localStorage.setItem('index_compact_view', tbl.classList.contains('compact-view') ? '1' : '0'); } catch(e){}
        }

        // Apply persisted compact view on load
        try {
            if (localStorage.getItem('index_compact_view') === '1') {
                const t = document.getElementById('tablaFinanzas');
                const b = document.getElementById('compactToggleIndex');
                if (t) t.classList.add('compact-view');
                if (b) b.classList.add('active');
            }
        } catch(e) {}

        // Observe newly added tables and apply compact-view if user enabled it
        (function observeTablesForCompactIndex(){
            try{
                const enabled = localStorage.getItem('index_compact_view') === '1';
                if (!enabled) return;
                const applyToNode = (node) => {
                    if (!node) return;
                    if (node.tagName === 'TABLE') node.classList.add('compact-view');
                    if (node.querySelectorAll) node.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
                };
                document.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
                const mo = new MutationObserver(muts=>{
                    muts.forEach(m=>{ m.addedNodes && m.addedNodes.forEach(n=>{ if (n.nodeType===1) applyToNode(n); }); });
                });
                mo.observe(document.body, { childList: true, subtree: true });
            } catch(e){}
        })();

        function inicializar() {
            cargarProyectos();
            mostrarMovimientos();
            verificarVencimientos();
        }

        function cargarProyectos() {
            const proysA = JSON.parse(localStorage.getItem('wm_proyectos') || "[]");
            const proysB = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || "[]");
            const normalized = [];
            (proysA || []).forEach(p => normalized.push({ nombre: p.nombre || p.name || p.proyecto || '', total: p.total || p.precio || '', totalNumber: p.totalNumber || (typeof p.total === 'number' ? p.total : undefined), _raw: p }));
            (proysB || []).forEach(p => {
                const nombre = p.proyecto || p.cliente || p.nombre || p.id || '';
                const costoRaw = p.costo || p.costo_estimado || p.costo || '';
                let totalNumber = 0;
                if (typeof costoRaw === 'number') totalNumber = costoRaw;
                else if (typeof costoRaw === 'string') totalNumber = parseFloat(costoRaw.toString().replace(/[^0-9.,-]+/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
                normalized.push({ nombre, total: costoRaw, totalNumber, _raw: p });
            });
            const map = {};
            normalized.forEach(p => { if (p.nombre) map[p.nombre] = p; });
            const proys = Object.values(map);
            const select = document.getElementById('selectProyecto');
            const selectFiltro = document.getElementById('filtroProyectoBalance');
            const options = proys.map(p => `<option style="color:#0f172a;background:#fff" value="${p.nombre}">${p.nombre}</option>`).join('');
            if (select) select.innerHTML = options;
            if (selectFiltro) selectFiltro.innerHTML = options;
            if (proys.length > 0) renderizarBalance();
        }

        function renderizarBalance() {
            const proyectoSel = document.getElementById('filtroProyectoBalance') ? document.getElementById('filtroProyectoBalance').value : (document.getElementById('selectProyecto') ? document.getElementById('selectProyecto').value : null);
            if (!proyectoSel) return;
            const rawA = JSON.parse(localStorage.getItem('wm_proyectos') || "[]");
            const rawB = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || "[]");
            const norm = [];
            (rawA || []).forEach(p => norm.push({ nombre: p.nombre || p.proyecto || p.name || '', total: p.total, totalNumber: p.totalNumber, _raw: p }));
            (rawB || []).forEach(p => {
                const nombre = p.proyecto || p.cliente || p.nombre || p.id || '';
                const costoRaw = p.costo || p.costo_estimado || p.costo || '';
                let totalNumber = 0;
                if (typeof costoRaw === 'number') totalNumber = costoRaw;
                else if (typeof costoRaw === 'string') totalNumber = parseFloat(costoRaw.toString().replace(/[^0-9.,-]+/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
                norm.push({ nombre, total: costoRaw, totalNumber, _raw: p });
            });
            const proyectos = norm;
            const proyData = proyectos.find(p => p.nombre === proyectoSel) || null;
            let presupuestoTotal = 0;
            if (proyData) {
                if (typeof proyData.totalNumber === 'number') presupuestoTotal = proyData.totalNumber;
                else if (typeof proyData.total === 'string') presupuestoTotal = parseFloat((proyData.total || '').toString().replace(/[^0-9.,-]+/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
            }
            const finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || "[]");
            const startInput = document.getElementById('startDateFilter') ? document.getElementById('startDateFilter').value : '';
            const endInput = document.getElementById('endDateFilter') ? document.getElementById('endDateFilter').value : '';
            const startDate = startInput ? new Date(startInput) : null;
            const endDate = endInput ? new Date(endInput) : null;
            const movs = finanzas.filter(m => {
                if (m.proyecto !== proyectoSel) return false;
                if (!startDate && !endDate) return true;
                const d = parseDateFlexible(m.fecha);
                if (!d) return false;
                if (startDate && d < startDate) return false;
                if (endDate && d > endDate) return false;
                return true;
            });
            const totalIngresos = movs.filter(m => m.tipo === 'INGRESO').reduce((acc, m) => acc + (parseFloat(m.total) || 0), 0);
            const totalGastos = movs.filter(m => m.tipo === 'GASTO').reduce((acc, m) => acc + (parseFloat(m.total) || 0), 0);
            const porcIngreso = presupuestoTotal > 0 ? (totalIngresos / presupuestoTotal) * 100 : 0;
            const porcGasto = presupuestoTotal > 0 ? (totalGastos / presupuestoTotal) * 100 : 0;
            const nombreEl = document.getElementById('nombreProyActivo'); if (nombreEl) nombreEl.innerText = proyectoSel;
            const barIng = document.getElementById('progresoIngresos'); if (barIng) { barIng.style.width = `${Math.min(porcIngreso, 100)}%`; barIng.innerText = `${porcIngreso.toFixed(1)}%`; }
            const barGas = document.getElementById('progresoGastos'); if (barGas) { barGas.style.width = `${Math.min(porcGasto, 100)}%`; barGas.innerText = `${porcGasto.toFixed(1)}%`; }
            const saldoEl = document.getElementById('saldoCaja'); const pendienteEl = document.getElementById('pendienteCobro'); if (saldoEl) saldoEl.innerText = formatCurrency((totalIngresos - totalGastos),2); if (pendienteEl) pendienteEl.innerText = formatCurrency((presupuestoTotal - totalIngresos),2);
            try { updateKPIsAndChart(proyectoSel, presupuestoTotal, totalIngresos, totalGastos, startDate, endDate); } catch(e){ console.warn('updateKPIs error', e); }
        }

        function animateValue(el, start, end, duration=800) {
            const node = document.getElementById(el);
            if (!node) return;
            const startTime = performance.now();
            function step(now){
                const t = Math.min((now - startTime) / duration, 1);
                const val = start + (end - start) * t;
                node.innerText = (typeof end === 'number') ? formatCurrency(val, 2) : val;
                if (t < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        let finChart = null;
        let cierreChart = null;

        function generarCierreProyecto() {
            const proyectoSel = document.getElementById('filtroProyectoBalance') ? document.getElementById('filtroProyectoBalance').value : null;
            if (!proyectoSel) { wmToast("Seleccione un proyecto primero."); return; }
            const rawA = JSON.parse(localStorage.getItem('wm_proyectos') || "[]");
            const rawB = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || "[]");
            const proyectos = [];
            (rawA || []).forEach(p => proyectos.push({ nombre: p.nombre || p.proyecto || p.name || '', total: p.total, totalNumber: p.totalNumber, _raw: p }));
            (rawB || []).forEach(p => {
                const nombre = p.proyecto || p.cliente || p.nombre || p.id || '';
                const costoRaw = p.costo || p.costo_estimado || p.costo || '';
                let totalNumber = 0;
                if (typeof costoRaw === 'number') totalNumber = costoRaw;
                else if (typeof costoRaw === 'string') totalNumber = parseFloat(costoRaw.toString().replace(/[^0-9.,-]+/g,'').replace(/\./g,'').replace(/,/g,'.')) || 0;
                proyectos.push({ nombre, total: costoRaw, totalNumber, _raw: p });
            });
            const finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || "[]");
            const proyData = proyectos.find(p => p.nombre === proyectoSel) || null;
            let presupuestoPlan = 0;
            if (proyData) {
                if (typeof proyData.totalNumber === 'number') presupuestoPlan = proyData.totalNumber;
                else if (typeof proyData.total === 'string') presupuestoPlan = parseCurrency(proyData.total) || 0;
            }
            const movs = finanzas.filter(m => m.proyecto === proyectoSel);
            const ingresosReales = movs.filter(m => m.tipo === 'INGRESO').reduce((acc, m) => acc + (Number(m.total) || 0), 0);
            const gastosReales = movs.filter(m => m.tipo === 'GASTO').reduce((acc, m) => acc + (Number(m.total) || 0), 0);
            const utilidadReal = ingresosReales - gastosReales;
            const margenReal = ingresosReales > 0 ? (utilidadReal / ingresosReales) * 100 : 0;
            const gastosPorCat = {};
            movs.filter(m => m.tipo === 'GASTO').forEach(m => { const cat = m.cat || 'otros'; gastosPorCat[cat] = (gastosPorCat[cat] || 0) + (Number(m.total) || 0); });
            const informeDiv = document.getElementById('informeCierre'); if (informeDiv) informeDiv.classList.remove('hidden');
            if (document.getElementById('fechaCierre')) document.getElementById('fechaCierre').innerText = `Generado el: ${new Date().toLocaleString()}`;
            const detalle = document.getElementById('detalleCierre');
            detalle.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin: 10px 0;"><span>Presupuesto Original:</span> <strong>${formatCurrency(presupuestoPlan,2)}</strong></div>
                <div style="display: flex; justify-content: space-between; margin: 10px 0;"><span>Total Cobrado:</span> <strong>${formatCurrency(ingresosReales,2)}</strong></div>
                <div style="display: flex; justify-content: space-between; margin: 10px 0; color: var(--danger);"><span>Total Gastado:</span> <strong>- ${formatCurrency(gastosReales,2)}</strong></div>
                <hr>
                <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.2em;"><span>GANANCIA NETA:</span> <strong style="color: var(--success);">${formatCurrency(utilidadReal,2)}</strong></div>
                <div style="text-align: center; background: var(--s); padding: 10px; border-radius: 5px; margin-top: 10px;"><p style="margin:0;">Margen de Utilidad Real: <strong>${margenReal.toFixed(1)}%</strong></p><small>${margenReal >= 12 ? '‚úÖ Proyecto Rentable' : '‚ö†Ô∏è Margen por debajo de lo planeado'}</small></div>
                <hr>
                <h4>Desglose de Gastos por Categor√≠a</h4>
                <div id="listaGastosCat" style="margin-top:8px;">
                    ${Object.keys(gastosPorCat).length === 0 ? '<em>No hay gastos registrados.</em>' : Object.entries(gastosPorCat).map(([k,v])=>`<div style="display:flex; justify-content:space-between; padding:4px 0;"><span>${k}</span><strong>${formatCurrency(v,2)}</strong></div>`).join('')}
                </div>
            `;
            const ctx = document.getElementById('graficoCierre').getContext('2d');
            const labels = Object.keys(gastosPorCat);
            const data = labels.map(l=>gastosPorCat[l]);
            if (cierreChart) { try { cierreChart.destroy(); } catch(e){} cierreChart = null; }
            if (labels.length > 0) {
                cierreChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: labels.map((_,i)=>['#ff6384','#36a2eb','#ffcd56','#4bc0c0','#9966ff','#c9cbcf'][i%6]) }] }, options: { responsive:true, maintainAspectRatio:false } });
            } else { ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }
            if (informeDiv) informeDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function updateKPIsAndChart(projecto, presupuestoTotal, totalIngresos, totalGastos) {
            animateValue('kpiPresupuesto', 0, presupuestoTotal || 0);
            animateValue('kpiCobrado', 0, totalIngresos || 0);
            animateValue('kpiGastado', 0, totalGastos || 0);
            animateValue('kpiMargen', 0, (totalIngresos - totalGastos) || 0);
            let finanzasAll = JSON.parse(localStorage.getItem('wm_finanzas') || '[]').filter(m => m.proyecto === projecto);
            const startDate = arguments[4] || null; const endDate = arguments[5] || null;
            if (startDate || endDate) { finanzasAll = finanzasAll.filter(m => { const d = parseDateFlexible(m.fecha); if (!d) return false; if (startDate && d < startDate) return false; if (endDate && d > endDate) return false; return true; }); }
            const finanzas = finanzasAll;
            const months = []; const now = new Date();
            for (let i = 5; i >= 0; i--) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; months.push({ key, label: d.toLocaleString(undefined,{month:'short', year:'numeric'}) }); }
            const ingresosSeries = months.map(m => { const [y, mm] = m.key.split('-').map(x=>parseInt(x,10)); const sum = finanzas.filter(f => { if (f.tipo !== 'INGRESO') return false; const fd = parseDateFlexible(f.fecha); if (!fd) return false; return fd.getFullYear() === y && (fd.getMonth()+1) === mm; }).reduce((a,b)=>a+(parseFloat(b.total)||0),0); return sum; });
            const gastosSeries = months.map(m => { const [y, mm] = m.key.split('-').map(x=>parseInt(x,10)); const sum = finanzas.filter(f => { if (f.tipo !== 'GASTO') return false; const fd = parseDateFlexible(f.fecha); if (!fd) return false; return fd.getFullYear() === y && (fd.getMonth()+1) === mm; }).reduce((a,b)=>a+(parseFloat(b.total)||0),0); return sum; });
            const labels = months.map(m => m.label);
            if (!finChart) { const ctx = document.getElementById('chartFinanzas').getContext('2d'); finChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Ingresos', data: ingresosSeries, backgroundColor: 'rgba(40,167,69,0.8)' }, { label: 'Gastos', data: gastosSeries, backgroundColor: 'rgba(220,53,69,0.8)' } ] }, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } } }); } else { finChart.data.labels = labels; finChart.data.datasets[0].data = ingresosSeries; finChart.data.datasets[1].data = gastosSeries; finChart.update(); }
        }

        function parseDateFlexible(txt) {
            if (!txt) return null; if (txt instanceof Date) return txt; const iso = Date.parse(txt); if (!isNaN(iso)) return new Date(iso);
            const parts = txt.toString().trim().split(/[\/\-\.]/).map(s=>s.trim());
            if (parts.length === 3) { if (parts[0].length === 4) return new Date(parts[0] + '-' + parts[1] + '-' + parts[2]); const dd = parseInt(parts[0],10); const mm = parseInt(parts[1],10); const yyyy = parseInt(parts[2],10); if (!isNaN(dd) && !isNaN(mm) && !isNaN(yyyy)) return new Date(yyyy, mm-1, dd); }
            const d = new Date(txt); if (!isNaN(d.getTime())) return d; return null;
        }

        function configForm(tipo) { const el = document.getElementById('tipoMovimiento'); if (el) el.value = tipo; const form = document.getElementById('formFinanzas'); if (form) form.style.borderTop = `5px solid ${tipo === 'INGRESO' ? '#28a745' : '#dc3545'}`; }

        function mostrarCamposExtra() { const cat = document.getElementById('categoria').value; const extras = document.getElementById('extras'); if (['material', 'herramienta', 'subcontrato'].includes(cat)) extras.classList.remove('hidden'); else extras.classList.add('hidden'); }

        function calcTotal() { const c = Number(document.getElementById('cant').value || 0); const u = Number(document.getElementById('pu').value || 0); const out = document.getElementById('totalMov'); if (out) out.value = (c * u).toFixed(2); }

        function guardarMovimiento() {
            const mov = { proyecto: (document.getElementById('selectProyecto')||{}).value, tipo: (document.getElementById('tipoMovimiento')||{}).value, cat: (document.getElementById('categoria')||{}).value, desc: (document.getElementById('desc')||{}).value, total: parseFloat((document.getElementById('totalMov')||{}).value)||0, fecha: new Date().toLocaleDateString(), fechaFin: (document.getElementById('fechaFin')||{}).value, proveedor: (document.getElementById('proveedor')||{}).value };
            let finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || "[]"); finanzas.push(mov); localStorage.setItem('wm_finanzas', JSON.stringify(finanzas)); wmToast("Movimiento guardado y sincronizado localmente."); location.reload();
        }

        function mostrarMovimientos() {
            const finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || "[]");
            const cuerpo = document.getElementById('cuerpoFinanzas');
            const proyectoFiltroEl = document.getElementById('filtroProyectoBalance');
            const proyectoFiltro = proyectoFiltroEl ? proyectoFiltroEl.value : (document.getElementById('selectProyecto') ? document.getElementById('selectProyecto').value : null);
            const startInput = document.getElementById('startDateFilter') ? document.getElementById('startDateFilter').value : '';
            const endInput = document.getElementById('endDateFilter') ? document.getElementById('endDateFilter').value : '';
            const startDate = startInput ? new Date(startInput) : null;
            const endDate = endInput ? new Date(endInput) : null;
            const filtrados = finanzas.filter(m => { if (proyectoFiltro && m.proyecto !== proyectoFiltro) return false; if (!startDate && !endDate) return true; const d = parseDateFlexible(m.fecha); if (!d) return false; if (startDate && d < startDate) return false; if (endDate && d > endDate) return false; return true; });
            filtrados.sort((a,b)=>{ const da = parseDateFlexible(a.fecha); const db = parseDateFlexible(b.fecha); if (da && db) return db - da; return 0; });
            const mostrar = filtrados.slice(0,10);
            if (cuerpo) cuerpo.innerHTML = mostrar.map(m => `<tr><td>${m.fecha}</td><td>${m.proyecto}</td><td style="color:${m.tipo === 'INGRESO' ? 'green' : 'red'}">${m.tipo}</td><td>${m.desc}</td><td>${formatCurrency(Number(m.total || 0),2)}</td></tr>`).join('');
        }

        function limpiarFiltro() { const s = document.getElementById('startDateFilter'); const e = document.getElementById('endDateFilter'); if (s) s.value = ''; if (e) e.value = ''; renderizarBalance(); mostrarMovimientos(); }

        function verificarVencimientos() {
            const finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || "[]"); const hoy = new Date(); const alertaDiv = document.getElementById('seccionAlertas');
            (finanzas || []).forEach(m => { if (m && m.fechaFin && m.cat === 'herramienta') { const vencimiento = new Date(m.fechaFin); const diffTime = vencimiento - hoy; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays <= 5 && diffDays >= 0) { if (alertaDiv) alertaDiv.innerHTML += `<div class="alerta"><i class="fas fa-exclamation-triangle"></i> ALERTA: El equipo "<strong>${m.desc}</strong>" vence en ${diffDays} d√≠as (${m.fechaFin}). Proveedor: ${m.proveedor}</div>`; } } });
        }
    </script>
</body>
</html>