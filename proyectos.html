<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WM/M&S - Gesti√≥n de Campo</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- 'theme-color' is not fully supported in Firefox and Opera, but causes no harm -->
    <!-- 'theme-color' is not fully supported in Firefox and Opera, but causes no harm -->
    <meta name="theme-color" content="#00447C">
    <!-- Mejora compatibilidad: color de tema para navegadores que soportan media queries -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#00447C">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000b1a">
    <meta name="color-scheme" content="light dark">
    <!-- Tailwind para dise√±o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html2pdf para exportaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="css/common-responsive.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        :root {
            --azul-corp: #000b1a; 
            --mostaza: #ccac00;  
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        .header-bg {
            background-color: var(--azul-corp);
            border-bottom: 4px solid var(--mostaza);
        }

        .mostaza-text { color: var(--mostaza); }
        .mostaza-bg { background-color: var(--mostaza); }
        .mostaza-border { border-color: var(--mostaza); }

        .form-input {
            width: 100%;
            padding: 0.85rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            background: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--mostaza);
            box-shadow: 0 0 0 3px rgba(204, 172, 0, 0.15);
        }

        .label-style {
            font-size: 0.7rem;
            font-weight: 800;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            margin-bottom: 0.35rem;
            display: block;
        }

        .page-fade {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos personalizados para el buscador */
        .search-item:hover {
            background-color: rgba(204, 172, 0, 0.1);
            cursor: pointer;
        }

        /* Animaci√≥n al cambiar valores */
        .value-change {
            transform: scale(1.03);
            transition: transform 300ms ease, opacity 300ms ease;
        }
        .value-anim {
            display: inline-block;
            will-change: transform, opacity;
        }
        /* Mejor contraste para selects y opciones */
        select.form-input, select#proySelectForCalc {
            color: #0f172a; /* texto oscuro */
            background-color: #ffffff; /* fondo blanco */
            border: 1px solid #d1d5db;
            padding: 0.6rem;
        }
        select.form-input:focus, select#proySelectForCalc:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(204,172,0,0.12);
            border-color: var(--mostaza);
        }
        option {
            color: #0f172a;
            background-color: #ffffff;
        }
        /* Responsive header and button sizes */
        @media (max-width: 640px) {
            header.header-bg { padding: 10px; }
            header.header-bg .leading-tight h1 { font-size: 1rem; }
            header.header-bg img { height:44px; }
            .header-actions { display:flex; gap:8px; align-items:center; }
            .header-actions button { padding:8px; }
            .form-input { padding:0.6rem; }
            .label-style { font-size:0.65rem; }
        }
        /* Resultado de b√∫squeda: seleccionado visible */
        .search-item { color: #0f172a; }
        .search-item.selected { background-color: var(--mostaza); color: #08121a; }
    </style>
    <script src="wm_toast.js"></script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ENCABEZADO CORPORATIVO -->
    <header class="header-bg p-4 md:p-6 text-white shadow-2xl z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="logo.png" alt="Logo CONSTRUCTORA WM/M&S" style="height:56px;max-width:100%;width:auto;object-fit:contain;margin-right:6px">
                <button onclick="location.href='index.html'" class="p-2 hover:bg-white/10 rounded-full transition-colors" title="Ir a Inicio">
                    <i data-lucide="home" class="mostaza-text w-6 h-6 md:w-8 md:h-8"></i>
                </button>
                <div class="leading-tight">
                    <h1 class="text-xl md:text-3xl font-black tracking-tighter uppercase">
                        CONSTRUCTORA <span class="mostaza-text">WM/M&S</span>
                    </h1>
                    <p class="text-[9px] md:text-xs font-light tracking-[0.25em] mostaza-text opacity-90 uppercase">
                        EDIFICANDO TU FUTURO
                    </p>
                </div>
            </div>
            <div class="text-right header-actions">
                <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
                    <button onclick="location.href='index.html'" title="Ir a Inicio" class="p-2 hover:bg-white/10 rounded-full transition-colors" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)">
                        <i data-lucide="home" class="mostaza-text w-6 h-6 md:w-8 md:h-8"></i>
                    </button>
                    <div style="text-align:right;">
                        <div id="clock-date" class="text-[10px] font-bold uppercase text-gray-400 mb-1"></div>
                        <div id="clock-time" class="text-lg md:text-2xl font-black mostaza-text"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- √ÅREA DE CONTENIDO -->
    <main id="content-area" class="flex-grow">
        
        <!-- P√ÅGINA: INICIO / BUSCADOR -->
        <section id="page-inicio" class="page-fade p-6 flex flex-col items-center justify-center min-h-[70vh]">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gray-900 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl border-2 mostaza-border">
                    <i data-lucide="building-2" class="w-10 h-10 mostaza-text"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Panel de Gesti√≥n de Proyectos</h2>
                <p class="text-gray-500 text-sm">Busque un proyecto existente o cree uno nuevo</p>
            </div>
            
            <!-- BUSCADOR PRINCIPAL -->
            <div class="w-full max-w-2xl mb-12 relative">
                <div class="flex items-center bg-white rounded-2xl shadow-xl border-2 border-transparent focus-within:border-[#ccac00] transition-all overflow-hidden p-2">
                    <i data-lucide="search" class="text-gray-400 ml-4"></i>
                    <input type="text" id="mainSearch" oninput="handleSearch(this.value)" placeholder="Buscar por cliente o nombre de proyecto..." class="w-full p-4 outline-none text-lg">
                </div>
                <!-- Resultados de b√∫squeda -->
                <div id="searchResults" class="absolute w-full mt-2 bg-white rounded-xl shadow-2xl border hidden z-[100] max-h-60 overflow-y-auto">
                    <!-- Din√°mico -->
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                <button onclick="newProject()" class="p-6 bg-white border-2 border-transparent hover:border-[#ccac00] rounded-2xl shadow-lg flex items-center gap-4 transition-all group">
                    <div class="bg-blue-100 p-3 rounded-xl group-hover:bg-[#ccac00] transition-colors">
                        <i data-lucide="plus" class="text-blue-600 group-hover:text-white"></i>
                    </div>
                    <div class="text-left">
                        <span class="block font-bold text-gray-800">Nueva Captaci√≥n</span>
                        <span class="text-xs text-gray-500">Registro t√©cnico de campo</span>
                    </div>
                </button>
                
                <button onclick="syncGoogle()" class="p-6 bg-white border-2 border-transparent hover:border-[#ccac00] rounded-2xl shadow-lg flex items-center gap-4 transition-all group">
                    <div class="bg-green-100 p-3 rounded-xl group-hover:bg-[#ccac00] transition-colors">
                        <i data-lucide="refresh-cw" class="text-green-600 group-hover:text-white"></i>
                    </div>
                    <div class="text-left">
                        <span class="block font-bold text-gray-800">Sincronizar Nube</span>
                        <span class="text-xs text-gray-500">Actualizar Google Sheets</span>
                    </div>
                </button>
            </div>
            <div class="w-full max-w-2xl mt-4 flex items-center gap-3">
                <input type="file" id="importRenglonesFile" accept=".csv" style="display:none" onchange="importRenglonesFromFile(this)">
                <button onclick="document.getElementById('importRenglonesFile').click()" class="p-3 bg-white border border-gray-200 rounded-xl shadow-sm">‚ûï Importar Renglones (CSV)</button>
                <div class="text-sm text-gray-500">Formato esperado: <code>project_id,index,nombre,unidad,cantidad,precio,subtotal</code></div>
            </div>
            <!-- Modal de vista previa de importaci√≥n -->
            <div id="importPreviewModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl max-w-3xl w-full p-4 shadow-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold">Vista previa: Renglones detectados</h3>
                        <button onclick="closeImportPreview()" class="text-gray-500">Cerrar ‚úñ</button>
                    </div>
                    <div id="importPreviewContent" style="max-height:400px; overflow:auto; font-size:14px;"></div>
                            <div class="mt-3 grid grid-cols-1 gap-2">
                                <div id="csvMappingControls" style="font-size:13px; color:#374151"></div>
                                <div style="display:flex; gap:12px; align-items:center; font-size:13px;">
                                    <label class="flex items-center gap-2"><input type="radio" name="importTarget" value="custom" checked> Guardar como renglones personalizados</label>
                                    <label class="flex items-center gap-2"><input type="radio" name="importTarget" value="merge"> Fusionar en renglones base (asignar tipo):</label>
                                    <select id="importMergeTipo" style="padding:6px; border-radius:6px; border:1px solid #ddd;" title="Seleccionar tipo de proyecto para fusionar renglones">
                                        <option value="residencial">residencial</option>
                                        <option value="comercial">comercial</option>
                                        <option value="industrial">industrial</option>
                                        <option value="civil">civil</option>
                                        <option value="publica">publica</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center gap-3">
                                <label style="font-size:13px"><input type="checkbox" id="skipInvalidRows" checked> Omitir filas inv√°lidas</label>
                                <label style="font-size:13px"><input type="checkbox" id="skipDuplicates" checked> Omitir duplicados detectados</label>
                            </div>
                            <div class="mt-4 flex justify-end gap-2">
                                <button onclick="confirmImportAction()" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold">Confirmar importaci√≥n</button>
                                <button onclick="closeImportPreview()" class="px-3 py-2 bg-gray-100 rounded-xl">Cancelar</button>
                            </div>
                </div>
            </div>
            
            <div style="margin-top:12px; display:flex; gap:8px; width:100%; max-width:600px;">
                <button onclick="location.href='index.html'" class="p-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl" style="flex:1;">‚Üê Volver a Inicio</button>
                <button onclick="location.href='calculadora.html'" class="p-3 bg-gradient-to-r from-green-600 to-green-500 text-white rounded-xl" style="flex:1;">Ir a Calculadora ‚Üí</button>
            </div>

            <div style="margin-top:12px; display:flex; gap:8px; width:100%; max-width:900px;">
                <button onclick="abrirProyectoEnCalculadoraSeleccionado()" class="p-3 bg-indigo-600 text-white rounded-xl" style="flex:1;">Abrir proyecto seleccionado en Calculadora</button>
                <select id="proySelectForCalc" style="flex:2; padding:8px; border-radius:6px; border:1px solid #ddd;" title="Seleccionar proyecto para abrir en calculadora"></select>
            </div>

            <!-- Pruebas r√°pidas de formato -->
            <div class="w-full max-w-2xl mt-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <div class="flex items-center justify-between">
                        <div class="text-sm font-bold">Pruebas de Formato de Moneda</div>
                        <div class="flex gap-2">
                            <button onclick="simulateFormatTests()" class="px-3 py-2 bg-yellow-400 rounded-md text-black font-semibold">Ejecutar prueba</button>
                            <button onclick="resetFormatTests()" class="px-3 py-2 bg-gray-100 rounded-md">Limpiar</button>
                        </div>
                    </div>
                    <div id="formatTestResults" class="mt-3 text-sm text-gray-700"></div>
                </div>
            </div>
        </section>

        <!-- P√ÅGINA: FORMULARIO -->
        <section id="page-formulario" class="page-fade hidden p-4 md:p-8">
            <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
                <div class="p-4 md:p-8">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="file-text" class="mostaza-text"></i>
                            <h3 class="text-xl font-bold uppercase tracking-tight text-gray-700">Ficha T√©cnica del Proyecto</h3>
                        </div>
                        <span id="projectID" class="text-[10px] bg-gray-100 px-3 py-1 rounded-full font-mono text-gray-400">NUEVO_REGISTRO</span>
                    </div>

                    <form id="mainForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Izquierda -->
                        <div class="space-y-5">
                            <div>
                                <label class="label-style">Nombre del Cliente</label>
                                <input type="text" id="nombre_cliente" class="form-input" title="Nombre del Cliente">
                            </div>
                            <div>
                                <label class="label-style">Nombre del Proyecto</label>
                                <input type="text" id="nombre_proyecto" class="form-input" title="Nombre del Proyecto">
                            </div>
                            <div>
                                <label class="label-style">Ubicaci√≥n (GPS / Manual)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="ubicacion" class="form-input" placeholder="Coordenadas o direcci√≥n">
                                    <button type="button" onclick="getGPS()" class="p-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors" title="Obtener ubicaci√≥n GPS" aria-label="Obtener ubicaci√≥n GPS">
                                        <i data-lucide="map-pin" class="w-5 h-5 text-red-600" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="label-style">√Årea Terreno (m¬≤)</label>
                                    <input type="number" id="area_terreno" class="form-input" title="√Årea del Terreno (m2)">
                                </div>
                                <div>
                                    <label class="label-style">√Årea Construir (m¬≤)</label>
                                    <input type="number" id="area_construir" class="form-input" title="√Årea a Construir (m2)">
                                </div>
                            </div>
                        </div>

                        <!-- Derecha -->
                        <div class="space-y-5">
                            <div>
                                <label class="label-style">Tipo de Cubierta</label>
                                <select id="tipo_cubierta" class="form-input" title="Tipo de Cubierta">
                                    <option value="LOSA SOLIDA">LOSA S√ìLIDA</option>
                                    <option value="LOSA PREFABRICADA">LOSA PREFABRICADA</option>
                                    <option value="ESTRUCTURA METALICA">ESTRUCTURA MET√ÅLICA</option>
                                    <option value="PERGOLA">P√âRGOLA</option>
                                    <option value="TEJA">TEJA</option>
                                </select>
                            </div>

                            <div class="bg-gray-50 p-5 rounded-2xl border-2 border-dashed border-gray-200">
                                <button type="button" onclick="calcularConIA()" class="w-full bg-blue-900 hover:bg-blue-950 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-4 shadow-lg uppercase text-xs">
                                    <i data-lucide="sparkles" class="w-4 h-4 text-yellow-400"></i> Analizar con IA
                                </button>
                                <div class="space-y-4">
                                    <div>
                                        <label class="label-style text-blue-700">Presupuesto Estimado</label>
                                        <input type="text" id="costo_estimado" class="form-input font-black text-gray-800" readonly placeholder="Presupuesto estimado" title="Presupuesto Estimado">
                                    </div>
                                    <div>
                                        <label class="label-style text-green-700">Plazo de Ejecuci√≥n</label>
                                        <input type="text" id="duracion_estimada" class="form-input font-black text-gray-800" readonly placeholder="Plazo estimado" title="Plazo de Ejecuci√≥n Estimado">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="label-style">Fecha de Registro</label>
                                <input type="date" id="fecha_manual" class="form-input" title="Fecha de Registro">
                            </div>
                        </div>
                    </form>
                    <div id="projectFinanzas" class="mt-6 bg-white p-4 rounded-lg shadow-sm" style="display:none;">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-bold">Movimientos relacionados</div>
                            <div class="text-sm text-gray-500">Se muestran los movimientos asociados al proyecto/cliente</div>
                        </div>
                        <div id="projectFinanzasContent" style="max-height:240px; overflow:auto; font-size:13px;"></div>
                    </div>
                </div>
                
                <!-- Acciones -->
                <div class="bg-gray-100 px-8 py-6 flex flex-wrap gap-4 justify-between items-center">
                    <button onclick="showPage('inicio')" class="text-gray-500 font-bold flex items-center gap-2 hover:text-gray-800">
                        <i data-lucide="chevron-left"></i> Regresar al Buscador
                    </button>
                    <div class="flex gap-3">
                        <button onclick="saveProject()" class="mostaza-bg text-black px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-yellow-100">
                            <i data-lucide="save" class="w-5 h-5"></i> Guardar Proyecto
                        </button>
                        <button onclick="exportarPDF()" class="bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-gray-50">
                            <i data-lucide="printer" class="w-5 h-5"></i> Imprimir
                        </button>
                        <button id="compactToggleProjects" onclick="toggleCompactProjects()" class="bg-white border-2 border-gray-300 text-gray-700 px-4 py-3 rounded-xl font-bold" title="Vista Compacta">üóÇÔ∏è Compacta</button>
                        <div class="wm-tooltip">
                            <button id="globalCompactBtnProjects" class="compact-toggle-global" onclick="syncCompactGlobal()">üåê Compacta Global</button>
                            <div class="wm-tooltip-text">Sincroniza la vista compacta en todas las p√°ginas. Oculta columnas secundarias y aplica la vista a tablas nuevas.</div>
                        </div>
                        <div class="wm-tooltip">
                            <button id="configCompactProjects" class="compact-toggle-global" onclick="openCompactConfig()">‚öôÔ∏è Config</button>
                            <div class="wm-tooltip-text">Configurar qu√© columnas se ocultan en la Vista Compacta para esta p√°gina.</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- PLANTILLA PDF (OCULTA) -->
    <div id="pdf-preview" class="p-10 text-black bg-white" style="display: none; width: 800px;">
        <div style="border: 2px solid #000b1a; padding: 40px; border-radius: 4px;">
            <div style="background: #000b1a; color: white; padding: 30px; text-align: center; border-bottom: 6px solid #ccac00;">
                <h1 style="color: #ccac00; margin: 0; font-size: 32px; font-weight: 900;">CONSTRUCTORA WM/M&S</h1>
                <p style="margin: 10px 0 0 0; letter-spacing: 8px; font-size: 14px; opacity: 0.9;">EDIFICANDO TU FUTURO</p>
            </div>
            
            <div style="margin-top: 30px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 15px;">
                <span style="font-weight: 800; text-transform: uppercase; color: #555;">Ficha de Registro T√©cnica</span>
                <span id="pdf-date" style="font-family: monospace;"></span>
            </div>

            <table style="width: 100%; margin-top: 30px; border-collapse: collapse;">
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;"><strong>CLIENTE:</strong></td>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;" id="p-cliente"></td>
                </tr>
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;"><strong>PROYECTO:</strong></td>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;" id="p-proyecto"></td>
                </tr>
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;"><strong>UBICACI√ìN:</strong></td>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;" id="p-ubicacion"></td>
                </tr>
                <tr>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;"><strong>TIPO CUBIERTA:</strong></td>
                    <td style="padding: 15px; border-bottom: 1px solid #eee;" id="p-cubierta"></td>
                </tr>
            </table>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background: #f8f8f8; padding: 20px; border-radius: 10px; border-left: 5px solid #ccac00;">
                    <p style="font-size: 11px; color: #666; margin: 0;">√ÅREA DE CONSTRUCCI√ìN</p>
                    <p id="p-ac" style="font-size: 20px; font-weight: bold; margin: 5px 0 0 0;"></p>
                </div>
                <div style="background: #f8f8f8; padding: 20px; border-radius: 10px; border-left: 5px solid #000b1a;">
                    <p style="font-size: 11px; color: #666; margin: 0;">PRESUPUESTO ESTIMADO IA</p>
                    <p id="p-costo" style="font-size: 20px; font-weight: bold; margin: 5px 0 0 0; color: #1a3a5a;"></p>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 20px; background: #fffbe6; border-radius: 10px;">
                <p style="margin: 0;"><strong>PLAZO ESTIMADO:</strong> <span id="p-tiempo"></span></p>
            </div>

            <div style="margin-top: 100px; display: grid; grid-template-columns: 1fr 1fr; gap: 80px;">
                <div style="text-align: center; border-top: 1px solid #000; padding-top: 10px; font-size: 12px;">FIRMA AUTORIZADA WM/M&S</div>
                <div style="text-align: center; border-top: 1px solid #000; padding-top: 10px; font-size: 12px;">FIRMA DE CONFORMIDAD CLIENTE</div>
            </div>
        </div>
    </div>

    <!-- CARGADOR -->
    <div id="loader" class="fixed inset-0 bg-black/80 z-[1000] hidden flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-mostaza"></div>
        <p class="text-white font-bold mt-4 tracking-widest text-sm" id="loader-text">PROCESANDO...</p>
    </div>

    <script>
        lucide.createIcons();
        const apiKey = ""; // API Key de Gemini
        const scriptURL = ""; // Tu URL de Google Apps Script

        // Gesti√≥n de Estado Local
        function getProjects() {
            return JSON.parse(localStorage.getItem('WM_PROJECTS_DB')) || [];
        }

        function saveProject() {
            const projects = getProjects();
            const id = document.getElementById('projectID').innerText;
            
            const data = {
                id: id === 'NUEVO_REGISTRO' ? 'PROY-' + Date.now() : id,
                cliente: document.getElementById('nombre_cliente').value,
                proyecto: document.getElementById('nombre_proyecto').value,
                ubi: document.getElementById('ubicacion').value,
                at: document.getElementById('area_terreno').value,
                ac: document.getElementById('area_construir').value,
                cubierta: document.getElementById('tipo_cubierta').value,
                costo: document.getElementById('costo_estimado').value,
                tiempo: document.getElementById('duracion_estimada').value,
                fecha: document.getElementById('fecha_manual').value,
                timestamp: new Date().toISOString()
            };

            const index = projects.findIndex(p => p.id === data.id);
            if (index > -1) {
                projects[index] = data;
            } else {
                projects.push(data);
            }

            localStorage.setItem('WM_PROJECTS_DB', JSON.stringify(projects));
            document.getElementById('projectID').innerText = data.id;
            wmToast("Proyecto guardado exitosamente en el dispositivo.");
        }

        // Buscador
        function handleSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            if (!query) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const db = getProjects();
            const filtered = db.filter(p => 
                p.cliente.toLowerCase().includes(query.toLowerCase()) || 
                p.proyecto.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(p => `
                    <div onclick="loadProject('${p.id}')" class="search-item p-4 border-b last:border-0">
                        <div class="font-bold text-gray-800">${p.proyecto}</div>
                        <div class="text-xs text-gray-500">${p.cliente} | ${p.fecha}</div>
                    </div>
                `).join('');
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = `<div class="p-4 text-gray-400 text-sm">No se encontraron coincidencias</div>`;
                resultsDiv.classList.remove('hidden');
            }
        }

        function loadProject(id) {
            const db = getProjects();
            const p = db.find(item => item.id === id);
            if (!p) return;

            document.getElementById('projectID').innerText = p.id;
            document.getElementById('nombre_cliente').value = p.cliente;
            document.getElementById('nombre_proyecto').value = p.proyecto;
            document.getElementById('ubicacion').value = p.ubi;
            document.getElementById('area_terreno').value = p.at;
            document.getElementById('area_construir').value = p.ac;
            document.getElementById('tipo_cubierta').value = p.cubierta;
            document.getElementById('costo_estimado').value = p.costo;
            document.getElementById('duracion_estimada').value = p.tiempo;
            document.getElementById('fecha_manual').value = p.fecha;

            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('mainSearch').value = "";
            showPage('formulario');
        }

        function newProject() {
            document.getElementById('mainForm').reset();
            document.getElementById('projectID').innerText = 'NUEVO_REGISTRO';
            document.getElementById('fecha_manual').valueAsDate = new Date();
            showPage('formulario');
        }

        // Navegaci√≥n
        function showPage(page) {
            document.getElementById('page-inicio').classList.add('hidden');
            document.getElementById('page-formulario').classList.add('hidden');
            document.getElementById(`page-${page}`).classList.remove('hidden');
        }

        // GPS
        function getGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('ubicacion').value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                }, () => wmToast("Error al obtener GPS."));
            }
        }

        // IA: Gemini para estimaci√≥n de costos
        async function calcularConIA() {
            const area = document.getElementById('area_construir').value;
            const cubierta = document.getElementById('tipo_cubierta').value;
            const ubi = document.getElementById('ubicacion').value;

            if (!area || !ubi) { wmToast("Complete los datos de √Årea y Ubicaci√≥n primero."); return; }

            document.getElementById('loader-text').innerText = "CONSULTANDO FACTORES CON IA...";
            document.getElementById('loader').classList.remove('hidden');

            const prompt = `Analiza los costos de construcci√≥n actuales para la ubicaci√≥n: ${ubi}. Proyecto: construcci√≥n de ${area} m2 con sistema de cubierta: ${cubierta}. Determina un costo total estimado (especifica moneda seg√∫n zona) y un tiempo de ejecuci√≥n basado en rendimientos est√°ndar de mano de obra. Responde estrictamente en formato JSON: {"costo": "...", "tiempo": "..."}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const resData = await response.json();
                const jsonStr = resData.candidates[0].content.parts[0].text.replace(/```json|```/g, "");
                const obj = JSON.parse(jsonStr);

                document.getElementById('costo_estimado').value = obj.costo;
                document.getElementById('duracion_estimada').value = obj.tiempo;
            } catch (e) {
                wmToast("Error al conectar con la IA de estimaci√≥n.");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // Sincronizaci√≥n Google
        async function syncGoogle() {
            const db = getProjects();
            if(db.length === 0) { wmToast("No hay datos para sincronizar."); return; }

            document.getElementById('loader-text').innerText = "SINCRONIZANDO CON GOOGLE SHEETS...";
            document.getElementById('loader').classList.remove('hidden');

            try {
                // Sincronizamos todos los registros
                for (let data of db) {
                    await fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(data)
                    });
                }
                wmToast("Sincronizaci√≥n masiva completada.");
            } catch (e) {
                wmToast("Error de sincronizaci√≥n. Verifique URL de App Script.");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // PDF
        function exportarPDF() {
            document.getElementById('p-cliente').innerText = document.getElementById('nombre_cliente').value;
            document.getElementById('p-proyecto').innerText = document.getElementById('nombre_proyecto').value;
            document.getElementById('p-ubicacion').innerText = document.getElementById('ubicacion').value;
            document.getElementById('p-ac').innerText = document.getElementById('area_construir').value + " m¬≤";
            document.getElementById('p-cubierta').innerText = document.getElementById('tipo_cubierta').value;
            document.getElementById('p-costo').innerText = document.getElementById('costo_estimado').value;
            document.getElementById('p-tiempo').innerText = document.getElementById('duracion_estimada').value;
            document.getElementById('pdf-date').innerText = new Date().toLocaleString();

            const element = document.getElementById('pdf-preview');
            element.style.display = 'block';
            
            const opt = {
                margin: 0,
                filename: `WM_PROYECTO_${Date.now()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        }

        // Popular select para abrir en calculadora y funci√≥n de apertura
        function popularSelectProyectosParaCalculadora(){
            const db = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
            const sel = document.getElementById('proySelectForCalc');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Seleccione proyecto --</option>' + db.map(p=>`<option style="color:#0f172a;background:#fff" value="${p.id||p.proyecto}">${(p.proyecto||p.id)}${p.fecha? ' - '+p.fecha:''}</option>`).join('');
        }

        function abrirProyectoEnCalculadoraSeleccionado(){
            const sel = document.getElementById('proySelectForCalc');
            if (!sel) { wmToast('Seleccione un proyecto'); return; }
            const val = sel.value; if (!val) { wmToast('Seleccione un proyecto'); return; }
            let found = null;
            const db = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
            found = db.find(p => (p.id||p.proyecto) == val);
            if (!found) {
                const a = JSON.parse(localStorage.getItem('proyectos')||'[]');
                found = a.find(p => p.nombre === val || p.nombre === sel.options[sel.selectedIndex].text);
            }
            const openObj = found || { proyecto: sel.options[sel.selectedIndex].text };
            try { localStorage.setItem('WM_OPEN_PROJECT', JSON.stringify(openObj)); } catch(e){ console.warn(e); }
            location.href = 'calculadora.html';
        }

        function showProjectFinanzas(projectIdOrName){
            const container = document.getElementById('projectFinanzas');
            const content = document.getElementById('projectFinanzasContent');
            if (!container || !content) return;
            const all = JSON.parse(localStorage.getItem('wm_finanzas') || '[]');
            const proyecto = projectIdOrName || document.getElementById('projectID').innerText || '';
            const byProject = all.filter(m => (m.proyecto||'').toString() === proyecto || (m.cliente||'').toString().trim() === proyecto || (m.cliente||'').toString().trim().toLowerCase() === (proyecto||'').toString().trim().toLowerCase());
            if (!byProject || byProject.length === 0) { container.style.display='none'; content.innerHTML = '<div class="text-gray-500">No hay movimientos relacionados</div>'; return; }
            container.style.display='block';
            const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
            table.innerHTML = `<thead><tr style="background:#f7fafc"><th style="padding:6px;border:1px solid #eee">Fecha</th><th style="padding:6px;border:1px solid #eee">Descripci√≥n</th><th style="padding:6px;border:1px solid #eee">Proveedor</th><th style="padding:6px;border:1px solid #eee">Categor√≠a</th><th style="padding:6px;border:1px solid #eee">Tipo</th><th style="padding:6px;border:1px solid #eee">Total</th></tr></thead>`;
            const body = document.createElement('tbody');
            byProject.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="padding:6px;border:1px solid #eee">${m.fecha||''}</td><td style="padding:6px;border:1px solid #eee">${m.desc||m.descripcion||''}</td><td style="padding:6px;border:1px solid #eee">${m.proveedor||''}</td><td style="padding:6px;border:1px solid #eee">${m.categoria||''}</td><td style="padding:6px;border:1px solid #eee">${m.tipo||''}</td><td style="padding:6px;border:1px solid #eee">${typeof m.total !== 'undefined' ? (m.total) : (m.total = (Number(m.costo_unitario||0)*Number(m.cantidad||1)))}</td>`;
                body.appendChild(tr);
            });
            table.appendChild(body);
            content.innerHTML = '';
            content.appendChild(table);
        }

        // Reloj
        function tick() {
            const now = new Date();
            document.getElementById('clock-date').innerText = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('es-ES', { hour12: false });
        }
        setInterval(tick, 1000);
        tick();
        // Ejecutar popular select al cargar
        try { popularSelectProyectosParaCalculadora(); } catch(e){ }

    </script>
    <script>
        // Importar renglones CSV y mostrar vista previa antes de guardar
        let __lastParsedRenglones = [];
        let __lastParsedRenglonesParsed = null; // { header:[], rows:[] }
        function importRenglonesFromFile(input) {
            const file = input.files && input.files[0];
            if (!file) return wmToast('No se seleccion√≥ archivo.');
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const parsedObj = parseRenglonesCSV(text);
                if (!parsedObj || !parsedObj.rows || parsedObj.rows.length === 0) { wmToast('CSV vac√≠o o sin datos detectables.'); return; }
                __lastParsedRenglonesParsed = parsedObj;
                __lastParsedRenglones = parsedObj.rows;
                showImportPreview(parsedObj);
            };
            reader.readAsText(file);
        }

        function parseRenglonesCSV(text){
            const rawLines = text.split(/\r?\n/).map(l=>l.replace(/\uFEFF/g,'').trim()).filter(l=>l.length>0);
            if (rawLines.length < 2) return { header: [], rows: [] };
            // detectar separador (',' o ';')
            const firstLine = rawLines[0];
            const sep = firstLine.indexOf(';') !== -1 && firstLine.indexOf(',') === -1 ? ';' : ',';
            const lines = rawLines;
            if (lines.length < 2) return { header: [], rows: [] };
            const header = lines[0].split(sep).map(h=>h.trim());
            const headerLower = header.map(h=>h.toLowerCase());
            const idxOf = name => headerLower.findIndex(h=>h.indexOf(name) !== -1);
            const projectIdx = idxOf('project_id') >= 0 ? idxOf('project_id') : idxOf('project') >=0 ? idxOf('project') : -1;
            const indexIdx = idxOf('index');
            const nombreIdx = idxOf('nombre') >=0 ? idxOf('nombre') : idxOf('n')>=0 ? idxOf('n') : 0;
            const unidadIdx = idxOf('unidad') >=0 ? idxOf('unidad') : idxOf('u');
            const cantidadIdx = idxOf('cantidad') >=0 ? idxOf('cantidad') : idxOf('c');
            const precioIdx = idxOf('precio') >=0 ? idxOf('precio') : idxOf('p');
            const subtotalIdx = idxOf('subtotal') >=0 ? idxOf('subtotal') : -1;
            // detectar si es un CSV de finanzas (columnas: cliente, descripcion, cantidad, unidad, costo, tipo, categoria, fecha, proveedor)
            const isFinanzas = headerLower.some(h => h.includes('cliente')) || headerLower.some(h => h.includes('descripcion'));

            const proyectosDB = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
            const rows = [];
            for (let i=1;i<lines.length;i++){
                const parts = lines[i].split(sep).map(p=>p.trim());
                if (parts.length === 0) continue;
                let pid = projectIdx >= 0 ? parts[projectIdx] : '';
                if (!pid) {
                    const projNameIdx = headerLower.findIndex(h=>h.includes('proyecto')||h.includes('project_name')||h.includes('nombre'));
                    if (projNameIdx >= 0) pid = parts[projNameIdx];
                }
                if (!pid) pid = '';
                const isIdLike = pid.toString().startsWith('PROY-');
                if (!isIdLike && pid) {
                    const found = proyectosDB.find(p => (p.proyecto||p.nombre||'').toString().trim() === pid.toString().trim());
                    if (found && found.id) pid = found.id; else if (found && found.proyecto) pid = found.proyecto;
                }
                const renglon = {
                    __line: i+1,
                    __parts: parts.slice(),
                    project_id: pid,
                    index: indexIdx>=0 ? parts[indexIdx] : null,
                    n: nombreIdx>=0 ? parts[nombreIdx] : '',
                    u: unidadIdx>=0 ? parts[unidadIdx] : '',
                    cantidad: cantidadIdx>=0 ? (parseFloat(String(parts[cantidadIdx]||'').replace(/[^0-9.,-]/g,'').replace(/,/g,'.')) || 0) : 0,
                    precio: precioIdx>=0 ? (parseFloat(String(parts[precioIdx]||'').replace(/[^0-9.,-]/g,'').replace(/,/g,'.')) || 0) : 0,
                    subtotal: subtotalIdx>=0 ? (parseFloat(String(parts[subtotalIdx]||'').replace(/[^0-9.,-]/g,'').replace(/,/g,'.')) || null) : null,
                    ts: Date.now()
                };
                rows.push(renglon);
            }
            return { header, rows, type: isFinanzas ? 'finanzas' : 'renglones', sep };
        }

        function showImportPreview(parsedObj){
            const container = document.getElementById('importPreviewContent');
            if (!container) return;
            container.innerHTML = '';
            const headers = parsedObj.header || [];
            const rows = parsedObj.rows || [];

            // Construir controles de mapeo
            const mappingDiv = document.getElementById('csvMappingControls');
            mappingDiv.innerHTML = '';
            const expected = (parsedObj.type === 'finanzas') ? ['cliente','descripcion','cantidad','unidad','costo','tipo','categoria','fecha','proveedor'] : ['project_id','index','n','u','cantidad','precio','subtotal'];
            const selects = {};
            const headerOptions = ['--ninguno--'].concat(headers);
            expected.forEach(field => {
                const wrap = document.createElement('div');
                wrap.style.display = 'inline-block';
                wrap.style.marginRight = '8px';
                const label = document.createElement('label');
                label.style.fontSize = '12px';
                label.style.marginRight = '6px';
                label.innerText = field + ':';
                const sel = document.createElement('select');
                sel.style.padding = '6px';
                sel.style.border = '1px solid #ddd';
                sel.style.borderRadius = '6px';
                headerOptions.forEach(h => { const o = document.createElement('option'); o.value = h; o.innerText = h; sel.appendChild(o); });
                sel.dataset.field = field;
                sel.id = 'map_' + field;
                wrap.appendChild(label); wrap.appendChild(sel);
                mappingDiv.appendChild(wrap);
                selects[field] = sel;
            });

            // Clasificar y validar filas
            const mapping = {}; for (let k in selects) mapping[k] = selects[k].value; // valores iniciales
            function collectMapping() { for (let k in selects) mapping[k] = selects[k].value; }

            // Detectar duplicados contra base y dentro del archivo
            const keyBase = getPreferredRenglonesKey();
            let baseObj = {};
            try { baseObj = JSON.parse(localStorage.getItem(keyBase) || '{}'); } catch(e) { baseObj = {}; }
            const customObj = JSON.parse(localStorage.getItem('wm_custom_renglones') || '{}');

            function isDuplicateAgainstExisting(r) {
                const lists = [];
                // revisar en baseObj (todas las tipos)
                Object.keys(baseObj||{}).forEach(t => { (baseObj[t]||[]).forEach(it => lists.push(it)); });
                // revisar custom para su proyecto
                const customList = customObj[r.project_id] || [];
                customList.forEach(it=>lists.push(it));
                // comparar por nombre+unidad+precio (tolerancia)
                for (let it of lists) {
                    try {
                        const sameName = (it.n||'').toString().trim().toLowerCase() === (r.n||'').toString().trim().toLowerCase();
                        const sameU = (it.u||'').toString().trim().toLowerCase() === (r.u||'').toString().trim().toLowerCase();
                        const pIt = Number(it.p||it.precio||it.price||0);
                        const pR = Number(r.precio||0);
                        const priceClose = Math.abs(pIt - pR) < 0.01;
                        if (sameName && sameU && priceClose) return true;
                    } catch(e){ }
                }
                // load shared script for global sync
                (function(){ var s=document.createElement('script'); s.src='js/common-responsive.js'; document.head.appendChild(s); })();
                return false;
            }

            // Construir tabla con estado (valid / invalid / duplicate)
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            if (parsedObj.type === 'finanzas') {
                table.innerHTML = `<thead><tr style="background:#f3f4f6"><th style="padding:6px;border:1px solid #eee">#</th><th style="padding:6px;border:1px solid #eee">Cliente</th><th style="padding:6px;border:1px solid #eee">Descripci√≥n</th><th style="padding:6px;border:1px solid #eee">Unidad</th><th style="padding:6px;border:1px solid #eee">Cantidad</th><th style="padding:6px;border:1px solid #eee">Costo</th><th style="padding:6px;border:1px solid #eee">Tipo</th><th style="padding:6px;border:1px solid #eee">Proveedor</th><th style="padding:6px;border:1px solid #eee">Estado</th></tr></thead>`;
            } else {
                table.innerHTML = `<thead><tr style="background:#f3f4f6"><th style="padding:6px;border:1px solid #eee">#</th><th style="padding:6px;border:1px solid #eee">Project ID</th><th style="padding:6px;border:1px solid #eee">Nombre</th><th style="padding:6px;border:1px solid #eee">Unidad</th><th style="padding:6px;border:1px solid #eee">Cantidad</th><th style="padding:6px;border:1px solid #eee">Precio</th><th style="padding:6px;border:1px solid #eee">Subtotal</th><th style="padding:6px;border:1px solid #eee">Estado</th></tr></thead>`;
            }
            const body = document.createElement('tbody');

            // helper validation and rendering per tipo
            const seenInternal = new Set();
            rows.forEach((r, idx) => {
                const tr = document.createElement('tr');
                let issues = [];
                let estado = 'OK';
                let dupInternal = false;
                let dupExisting = false;
                if (parsedObj.type === 'finanzas') {
                    // expected fields: cliente, descripcion, cantidad, unidad, costo, tipo, categoria, fecha, proveedor
                    if (!r.__parts) {
                        // fallback: use existing properties
                    }
                    if (!r.cliente) {
                        const hLower = (parsedObj.header||[]).map(h=>h.toLowerCase());
                        const cidx = hLower.findIndex(h => h.includes('cliente'));
                        if (cidx >= 0 && r.__parts && r.__parts[cidx] !== undefined) r.cliente = r.__parts[cidx];
                    }
                    if (!r.descripcion) {
                        const hLower = (parsedObj.header||[]).map(h=>h.toLowerCase());
                        const didx = hLower.findIndex(h => h.includes('descripcion')||h.includes('desc'));
                        if (didx >= 0 && r.__parts && r.__parts[didx] !== undefined) r.descripcion = r.__parts[didx];
                    }
                    // normalize numbers
                    r.cantidad = Number(String(r.cantidad||'').replace(/[^0-9.,-]/g,'').replace(/,/g,'.'))||0;
                    r.costo = Number(String(r.costo||r.precio||'').replace(/[^0-9.,-]/g,'').replace(/,/g,'.'))||0;

                    if (!r.cliente || String(r.cliente).trim()==='') issues.push('cliente faltante');
                    if (!r.descripcion || String(r.descripcion).trim()==='') issues.push('descripcion faltante');
                    if (isNaN(Number(r.cantidad))) issues.push('cantidad no num√©rica');
                    if (Number(r.cantidad) < 0) issues.push('cantidad negativa');
                    if (isNaN(Number(r.costo))) issues.push('costo no num√©rico');
                    if (Number(r.costo) < 0) issues.push('costo negativo');

                    // duplicates: by cliente+descripcion+proveedor+costo
                    const internalKey = `${(r.cliente||'').toString().trim().toLowerCase()}::${(r.descripcion||'').toString().trim().toLowerCase()}::${(r.proveedor||'').toString().trim().toLowerCase()}::${Number(r.costo)||0}`;
                    dupInternal = seenInternal.has(internalKey);
                    seenInternal.add(internalKey);
                    // duplicate against existing finance entries
                    const finanzasAll = JSON.parse(localStorage.getItem('wm_finanzas')||'[]');
                    dupExisting = finanzasAll.some(f => (f.cliente||'').toString().trim().toLowerCase() === (r.cliente||'').toString().trim().toLowerCase() && (f.desc||'').toString().trim().toLowerCase() === (r.descripcion||'').toString().trim().toLowerCase() && Math.abs((Number(f.total)||0) - (Number(r.costo||0)*(Number(r.cantidad||1)||1)))<0.01);

                    if (issues.length>0) estado = 'ERROR: ' + issues.join('; ');
                    else if (dupInternal) estado = 'DUPLICADO (archivo)';
                    else if (dupExisting) estado = 'DUPLICADO (base)';

                    tr.innerHTML = `<td style="padding:6px;border:1px solid #eee">${r.__line||idx+1}</td><td style="padding:6px;border:1px solid #eee">${r.cliente||''}</td><td style="padding:6px;border:1px solid #eee">${r.descripcion||''}</td><td style="padding:6px;border:1px solid #eee">${r.unidad||r.u||''}</td><td style="padding:6px;border:1px solid #eee">${r.cantidad}</td><td style="padding:6px;border:1px solid #eee">${r.costo}</td><td style="padding:6px;border:1px solid #eee">${(r.tipo||'').toString().toUpperCase()}</td><td style="padding:6px;border:1px solid #eee">${r.proveedor||''}</td><td style="padding:6px;border:1px solid #eee">${estado}</td>`;
                    if (estado.startsWith('ERROR')) tr.style.background = '#ffe9e9';
                    else if (estado.includes('DUPLICADO')) tr.style.background = '#fff7e6';
                    body.appendChild(tr);
                } else {
                    const issuesLocal = [];
                    if (!r.project_id || String(r.project_id).trim()==='') issuesLocal.push('project_id faltante');
                    if (!r.n || String(r.n).trim()==='') issuesLocal.push('nombre faltante');
                    if (isNaN(Number(r.cantidad))) issuesLocal.push('cantidad no num√©rica');
                    if (Number(r.cantidad) < 0) issuesLocal.push('cantidad negativa');
                    if (isNaN(Number(r.precio))) issuesLocal.push('precio no num√©rico');
                    if (Number(r.precio) < 0) issuesLocal.push('precio negativo');
                    if ((r.subtotal === null || r.subtotal === undefined) && !isNaN(Number(r.precio)) && !isNaN(Number(r.cantidad))) {
                        r.subtotal = Number(r.precio) * Number(r.cantidad);
                    }
                    const internalKey = `${r.project_id}::${(r.n||'').toString().trim().toLowerCase()}::${(r.u||'').toString().trim().toLowerCase()}::${Number(r.precio)||0}`;
                    const dupInternalLocal = seenInternal.has(internalKey);
                    seenInternal.add(internalKey);
                    const dupExistingLocal = isDuplicateAgainstExisting(r);
                    let estadoLocal = 'OK';
                    if (issuesLocal.length>0) estadoLocal = 'ERROR: ' + issuesLocal.join('; ');
                    else if (dupInternalLocal) estadoLocal = 'DUPLICADO (archivo)';
                    else if (dupExistingLocal) estadoLocal = 'DUPLICADO (base)';
                    tr.innerHTML = `<td style="padding:6px;border:1px solid #eee">${r.__line||idx+1}</td><td style="padding:6px;border:1px solid #eee">${r.project_id}</td><td style="padding:6px;border:1px solid #eee">${r.n}</td><td style="padding:6px;border:1px solid #eee">${r.u}</td><td style="padding:6px;border:1px solid #eee">${r.cantidad}</td><td style="padding:6px;border:1px solid #eee">${r.precio}</td><td style="padding:6px;border:1px solid #eee">${r.subtotal===null?'-':r.subtotal}</td><td style="padding:6px;border:1px solid #eee">${estadoLocal}</td>`;
                    if (estadoLocal.startsWith('ERROR')) tr.style.background = '#ffe9e9';
                    else if (estadoLocal.includes('DUPLICADO')) tr.style.background = '#fff7e6';
                    body.appendChild(tr);
                }
            });

            table.appendChild(body);
            container.appendChild(table);
            document.getElementById('importPreviewModal').classList.remove('hidden');
            document.getElementById('importPreviewModal').classList.add('flex');
        }

        function closeImportPreview(){
            document.getElementById('importPreviewModal').classList.add('hidden');
            document.getElementById('importPreviewModal').classList.remove('flex');
            __lastParsedRenglones = [];
        }

        function getPreferredRenglonesKey(){
            return localStorage.getItem('RENGLONES_KEY_PREFERENCE') || 'renglones_base';
        }

        function confirmImportAction(){
            const target = document.querySelector('input[name="importTarget"]:checked').value;
            const tipo = document.getElementById('importMergeTipo').value || 'residencial';
            const skipInvalid = !!document.getElementById('skipInvalidRows') && document.getElementById('skipInvalidRows').checked;
            const skipDup = !!document.getElementById('skipDuplicates') && document.getElementById('skipDuplicates').checked;
            if (!__lastParsedRenglones || __lastParsedRenglones.length===0) { wmToast('No hay datos para importar.'); return; }

            // aplicar mapeo si el usuario seleccion√≥ columnas en el modal
            try {
                const parsed = __lastParsedRenglonesParsed;
                if (parsed && parsed.header && parsed.header.length > 0) {
                    const expectedFields = ['project_id','index','n','u','cantidad','precio','subtotal'];
                    const headerArr = parsed.header;
                    // construir mapping desde selects (map_<field>)
                    const mapping = {};
                    expectedFields.forEach(f => {
                        const sel = document.getElementById('map_' + f);
                        if (sel && sel.value && sel.value !== '--ninguno--') mapping[f] = sel.value;
                    });
                    if (Object.keys(mapping).length > 0) {
                        // remap cada parsed row using original parts
                        __lastParsedRenglones.forEach(r => {
                            if (!r.__parts) return;
                            for (let f of expectedFields) {
                                if (!mapping[f]) continue;
                                const colName = mapping[f];
                                const idx = headerArr.indexOf(colName);
                                if (idx >= 0 && r.__parts[idx] !== undefined) {
                                    const raw = r.__parts[idx];
                                    if (f === 'cantidad' || f === 'precio' || f === 'subtotal') {
                                        const v = parseFloat(String(raw).replace(/[^0-9.,-]/g,'').replace(/,/g, '.'));
                                        r[f] = isNaN(v) ? (r[f] || 0) : v;
                                    } else {
                                        r[f] = raw;
                                    }
                                }
                            }
                        });
                    }
                }
            } catch(e){ console.warn('Error aplicando mapping:', e); }

            // preparar detecciones
            const key = getPreferredRenglonesKey();
            let baseObj = {};
            try { baseObj = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e){ baseObj = {}; }
            const customObj = JSON.parse(localStorage.getItem('wm_custom_renglones') || '{}');

            function isDuplicateExisting(r) {
                const lists = [];
                Object.keys(baseObj||{}).forEach(t => { (baseObj[t]||[]).forEach(it => lists.push(it)); });
                const customList = customObj[r.project_id] || [];
                customList.forEach(it=>lists.push(it));
                for (let it of lists) {
                    try {
                        const sameName = (it.n||'').toString().trim().toLowerCase() === (r.n||'').toString().trim().toLowerCase();
                        const sameU = (it.u||'').toString().trim().toLowerCase() === (r.u||'').toString().trim().toLowerCase();
                        const pIt = Number(it.p||it.precio||it.price||0);
                        const pR = Number(r.precio||0);
                        const priceClose = Math.abs(pIt - pR) < 0.01;
                        if (sameName && sameU && priceClose) return true;
                    } catch(e){}
                }
                return false;
            }

            const finalRows = [];
            const seenInternal = new Set();
            let skippedInvalid = 0, skippedDup = 0;
            __lastParsedRenglones.forEach(r => {
                const issues = [];
                if (!r.project_id || String(r.project_id).trim()==='') issues.push('project_id faltante');
                if (!r.n || String(r.n).trim()==='') issues.push('nombre faltante');
                if (isNaN(Number(r.cantidad))) issues.push('cantidad no num√©rica');
                if (Number(r.cantidad) < 0) issues.push('cantidad negativa');
                if (isNaN(Number(r.precio))) issues.push('precio no num√©rico');
                if (Number(r.precio) < 0) issues.push('precio negativo');
                if ((r.subtotal === null || r.subtotal === undefined) && !isNaN(Number(r.precio)) && !isNaN(Number(r.cantidad))) {
                    r.subtotal = Number(r.precio) * Number(r.cantidad);
                }

                const internalKey = `${r.project_id}::${(r.n||'').toString().trim().toLowerCase()}::${(r.u||'').toString().trim().toLowerCase()}::${Number(r.precio)||0}`;
                const dupInternal = seenInternal.has(internalKey);
                seenInternal.add(internalKey);
                const dupExisting = isDuplicateExisting(r);

                if (issues.length>0 && skipInvalid) { skippedInvalid++; return; }
                if ((dupInternal || dupExisting) && skipDup) { skippedDup++; return; }
                finalRows.push(r);
            });

            // Si el CSV detectado es de tipo 'finanzas', procesar a wm_finanzas
            const parsedType = (__lastParsedRenglonesParsed && __lastParsedRenglonesParsed.type) ? __lastParsedRenglonesParsed.type : 'renglones';
            if (parsedType === 'finanzas') {
                // Mapear filas a movimientos financieros
                const finanzas = JSON.parse(localStorage.getItem('wm_finanzas') || '[]');
                const projects = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
                let added = 0;
                __lastParsedRenglones.forEach(r => {
                    // map/normalize fields
                    const cliente = (r.cliente || r.__parts && (() => {
                        const idx = (__lastParsedRenglonesParsed.header||[]).map(h=>h.toLowerCase()).findIndex(h=>h.includes('cliente'));
                        return idx>=0 ? r.__parts[idx] : '';
                    })() || '').toString().trim();
                    const desc = (r.descripcion || r.__parts && (() => {
                        const idx = (__lastParsedRenglonesParsed.header||[]).map(h=>h.toLowerCase()).findIndex(h=>h.includes('descripcion')||h.includes('desc'));
                        return idx>=0 ? r.__parts[idx] : '';
                    })() || '').toString().trim();
                    const cantidad = Number(String(r.cantidad||0).replace(/[^0-9.,-]/g,'').replace(/,/g,'.'))||0;
                    const costoRaw = String(r.costo||r.precio||'');
                    const costo = Number(costoRaw.replace(/[^0-9.,-]/g,'').replace(/,/g,'.'))||0;
                    const tipo = (r.tipo||'').toString().trim().toUpperCase() || ((r.__parts && (__lastParsedRenglonesParsed.header||[]).map(h=>h.toLowerCase()).some(h=>h.includes('tipo'))) ? (r.__parts[(__lastParsedRenglonesParsed.header||[]).map(h=>h.toLowerCase()).findIndex(h=>h.includes('tipo'))]||'') : '');
                    const categoria = (r.categoria||'').toString().trim();
                    const fecha = (r.fecha||'').toString().trim();
                    const proveedor = (r.proveedor||'').toString().trim();
                    const total = +(cantidad * costo) || costo || 0;
                    // localizar proyecto por cliente
                    const foundProject = projects.find(p => (p.cliente||'').toString().trim().toLowerCase() === cliente.toLowerCase());
                    const proyectoId = foundProject ? foundProject.id : cliente;
                    // decide skip rules
                    const issuesRow = [];
                    if (!cliente) issuesRow.push('cliente faltante');
                    if (!desc) issuesRow.push('descripcion faltante');
                    if (isNaN(cantidad)) issuesRow.push('cantidad no num√©rica');
                    if (isNaN(costo)) issuesRow.push('costo no num√©rico');
                    if (issuesRow.length>0 && skipInvalid) { skippedInvalid++; return; }
                    // duplicate detection against existing finanzas
                    const existingFin = finanzas.find(f => (f.cliente||'').toString().trim().toLowerCase()===cliente.toLowerCase() && (f.desc||'').toString().trim().toLowerCase()===desc.toLowerCase() && Math.abs((Number(f.total)||0)-total) < 0.01);
                    if (existingFin && skipDup) { skippedDup++; return; }

                    const mov = { proyecto: proyectoId, cliente: cliente, desc: desc, cantidad: cantidad, unidad: r.unidad||r.u||'', total: total, costo_unitario: costo, tipo: (tipo||'').toString().toUpperCase(), categoria: categoria, fecha: fecha, proveedor: proveedor };
                    finanzas.push(mov); added++;
                });
                try { localStorage.setItem('wm_finanzas', JSON.stringify(finanzas)); wmToast(`Importados ${added} movimientos financieros (omitidos inv√°lidos ${skippedInvalid}, duplicados ${skippedDup}).`); }
                catch(e){ wmToast('Error guardando movimientos financieros.'); }
                closeImportPreview();
                try { popularSelectProyectosParaCalculadora(); } catch(e){}
                return;
            }

            if (finalRows.length === 0) { wmToast('No hay filas v√°lidas para importar despu√©s de aplicar filtros.'); return; }

            if (target === 'custom') {
                let custom = {};
                try { custom = JSON.parse(localStorage.getItem('wm_custom_renglones') || '{}'); } catch(e){ custom = {}; }
                finalRows.forEach(r => {
                    const pid = r.project_id || 'UNKNOWN';
                    custom[pid] = custom[pid] || [];
                    custom[pid].push(r);
                });
                try { localStorage.setItem('wm_custom_renglones', JSON.stringify(custom)); wmToast(`Importados ${finalRows.length} renglones (omitidos inv√°lidos ${skippedInvalid}, duplicados ${skippedDup}).`); }
                catch(e){ wmToast('Error guardando renglones personalizados.'); }
            } else {
                let base = {};
                try { base = JSON.parse(localStorage.getItem(key) || '{}'); } catch(e){ base = {}; }
                base[tipo] = base[tipo] || [];
                finalRows.forEach(r => {
                    base[tipo].push({ n: r.n || '', u: r.u || '', c: Number(r.cantidad)||0, p: Number(r.precio)||0, m: '' });
                });
                try { localStorage.setItem(key, JSON.stringify(base)); wmToast(`Fusionados ${finalRows.length} renglones en '${key}' bajo tipo '${tipo}' (omitidos inv√°lidos ${skippedInvalid}, duplicados ${skippedDup}).`); }
                catch(e){ wmToast('Error fusionando renglones en base.'); }
            }
            closeImportPreview();
            try { popularSelectProyectosParaCalculadora(); } catch(e){}
        }
    </script>
    <script>
        /* ---------- Formateo y utilidades de moneda ---------- */
        function formatCurrency(value, decimals = 2) {
            const num = Number(value) || 0;
            // Usar Intl para formato local y luego prefijo 'Q '
            try {
                const formatted = num.toLocaleString('es-GT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
                return 'Q ' + formatted;
            } catch (e) {
                return 'Q ' + num.toFixed(decimals);
            }
        }

        function parseCurrency(str) {
            if (str === null || str === undefined) return NaN;
            const s = String(str).trim();
            // Eliminar prefijos y espacios
            let clean = s.replace(/[Q\s]/g, '');
            // Mantener d√≠gitos, puntos y comas
            clean = clean.replace(/[^0-9.,-]/g, '');
            // Si contiene '.' y ',' asumir que '.' es separador de miles y ',' decimal
            if (clean.indexOf('.') !== -1 && clean.indexOf(',') !== -1) {
                clean = clean.replace(/\./g, '').replace(/,/g, '.');
            } else if (clean.indexOf(',') !== -1 && clean.indexOf('.') === -1) {
                // solo coma => coma decimal
                clean = clean.replace(/,/g, '.');
            } else {
                // solo puntos o ninguno -> dejar
            }
            const num = Number(clean);
            return isNaN(num) ? NaN : num;
        }

        function animateValueChange(el) {
            if (!el) return;
            el.classList.add('value-change');
            setTimeout(() => el.classList.remove('value-change'), 450);
        }

        // Aplicar formato al establecer costo estimado (usado desde IA y carga)
        const original_calcularConIA = calcularConIA;
        async function calcularConIA_wrapped() {
            await original_calcularConIA();
            const el = document.getElementById('costo_estimado');
            const raw = el.value;
            const n = parseCurrency(raw);
            el.value = isNaN(n) ? raw : formatCurrency(n, 2);
            animateValueChange(el);
        }
        // Reemplazar referencia
        calcularConIA = calcularConIA_wrapped;

        // Al cargar un proyecto, formatear costo
        const original_loadProject = loadProject;
        function loadProject_wrapped(id) {
            original_loadProject(id);
            const el = document.getElementById('costo_estimado');
            const n = parseCurrency(el.value);
            if (!isNaN(n)) el.value = formatCurrency(n, 2);
            try { showProjectFinanzas(document.getElementById('projectID').innerText); } catch(e){}
        }
        loadProject = loadProject_wrapped;

        // Al exportar PDF, mostrar costo formateado
        const original_exportarPDF = exportarPDF;
        function exportarPDF_wrapped() {
            const el = document.getElementById('costo_estimado');
            const n = parseCurrency(el.value);
            document.getElementById('p-costo').innerText = isNaN(n) ? el.value : formatCurrency(n, 2);
            original_exportarPDF();
        }
        exportarPDF = exportarPDF_wrapped;

        // Al guardar, almacenar valor num√©rico (si se puede)
        const original_saveProject = saveProject;
        function saveProject_wrapped() {
            // Extraer n√∫mero y guardar temporalmente sin formato
            const el = document.getElementById('costo_estimado');
            const n = parseCurrency(el.value);
            if (!isNaN(n)) {
                // Guardar el valor desformateado y tambi√©n dejar visual el formateado
                el.value = formatCurrency(n, 2);
            }
            original_saveProject();
        }
        saveProject = saveProject_wrapped;

        // Pruebas r√°pidas UI
        function simulateFormatTests() {
            const samples = [0, 12.5, 1234.567, 1234567.89, -3456.7, 'Q 1.234,56', '1500'];
            const out = document.getElementById('formatTestResults');
            out.innerHTML = '';
            for (let s of samples) {
                const n = parseCurrency(s);
                const formatted = isNaN(n) ? ('(no num) ' + s) : formatCurrency(n, 2);
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center py-1';
                const left = document.createElement('div'); left.innerText = String(s);
                const right = document.createElement('div'); right.innerHTML = '<span class="value-anim">' + formatted + '</span>';
                row.appendChild(left); row.appendChild(right);
                out.appendChild(row);
                animateValueChange(right.querySelector('.value-anim'));
            }
        }

        function resetFormatTests(){ document.getElementById('formatTestResults').innerHTML = ''; }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try { await navigator.serviceWorker.register('./sw.js'); console.info('Service Worker registrado (proyectos)'); }
                catch(e){ console.warn('SW registration failed (proyectos):', e); }
            });
        }
    </script>
    <script>
        // Toggle compact view for visible tables on proyectos page
        function toggleCompactProjects() {
            const btn = document.getElementById('compactToggleProjects');
            const tables = Array.from(document.querySelectorAll('table'));
            if (!tables.length) return;
            let anyActive = false;
            tables.forEach(t => {
                t.classList.toggle('compact-view');
                if (t.classList.contains('compact-view')) anyActive = true;
            });
            if (btn) btn.classList.toggle('active');
            try { localStorage.setItem('projects_compact_view', anyActive ? '1' : '0'); } catch(e){}
        }

        // Apply persisted state
        try {
            if (localStorage.getItem('projects_compact_view') === '1') {
                const t = Array.from(document.querySelectorAll('table'));
                t.forEach(tab => tab.classList.add('compact-view'));
                const b = document.getElementById('compactToggleProjects'); if (b) b.classList.add('active');
            }
        } catch(e){}
        // Observe newly added tables and apply compact-view if user enabled it
        (function observeTablesForCompactProjects(){
            try{
                const enabled = localStorage.getItem('projects_compact_view') === '1';
                if (!enabled) return;
                const applyToNode = (node) => {
                    if (!node) return;
                    if (node.tagName === 'TABLE') node.classList.add('compact-view');
                    if (node.querySelectorAll) node.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
                };
                document.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
                const mo = new MutationObserver(muts=>{
                    muts.forEach(m=>{ m.addedNodes && m.addedNodes.forEach(n=>{ if (n.nodeType===1) applyToNode(n); }); });
                });
                mo.observe(document.body, { childList: true, subtree: true });
            } catch(e){}
        })();
    </script>
</body>
</html>