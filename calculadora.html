<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOFTCON-MYS-CONSTRU-WM | Pro Manager</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <script src="wm_toast.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="css/common-responsive.css">
    <style>
        /* Paleta de Colores SOFTCON-WM */
        :root {
            --color-principal: #00447C; /* Azul Intenso, como planos o acero */
            --color-secundario: #F0F4F8; /* Gris Claro de concreto fresco */
            --color-resaltar: #FFB300; /* Amarillo Seguridad, para acentos y advertencias */
            --color-texto: #333333; /* Gris oscuro para legibilidad */
            --color-fondo-claro: #FFFFFF; /* Blanco puro para secciones principales */
            --color-exito: #28a745; /* Verde para guardar */
            --color-advertencia: #e67e22; /* Naranja para importar */
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: var(--color-secundario);
            color: var(--color-texto);
        }
        
        header {
            background: var(--color-principal);
            color: var(--color-fondo-claro);
            text-align: center;
            padding: 1.5rem 1rem;
            border-bottom: 6px solid var(--color-resaltar);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; /* Para pantallas peque√±as */
        }
        header img {
            height: 60px; /* Ajusta el tama√±o de tu logo */
            max-width:100%;
            width:auto;
            margin-right: 15px;
        }
        header h1 {
            margin: 0;
            font-size: 2.2em;
            letter-spacing: 1px;
        }
        header p {
            margin: 5px 0 0;
            font-size: 1.1em;
            font-style: italic;
            color: #E0E0E0;
            width: 100%; /* Para que el eslogan est√© centrado debajo del t√≠tulo */
        }

        .nav-bar {
            display: flex;
            justify-content: space-around;
            background: var(--color-fondo-claro);
            padding: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            flex-wrap: wrap; /* Adaptabilidad */
            gap: 5px; /* Espacio entre botones */
        }
        .nav-bar button {
            flex-grow: 1; /* Para que los botones se expandan */
            min-width: 120px; /* Ancho m√≠nimo para cada bot√≥n */
            padding: 12px 10px;
            margin: 0; /* Eliminar margen para gap */
            border-radius: 5px;
            border: 1px solid var(--color-principal);
            background: var(--color-principal);
            color: var(--color-fondo-claro);
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .nav-bar button:hover {
            background: #0055AA;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .nav-bar button:active {
            transform: translateY(0);
        }

        .container {
            padding: 25px;
            max-width: 1200px;
            margin: auto;
        }
        .card {
            background: var(--color-fondo-claro);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 6px 10px rgba(0,0,0,0.08);
            border-left: 5px solid var(--color-resaltar);
        }
        .card h3 {
            color: var(--color-principal);
            margin-top: 0;
            border-bottom: 2px solid var(--color-secundario);
            padding-bottom: 10px;
        }
        select, input[type="number"], input[type="text"] {
            width: calc(100% - 24px); /* Ajustar el ancho para padding */
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Incluir padding en el ancho */
            font-size: 1em;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            border-color: var(--color-principal);
            box-shadow: 0 0 0 2px rgba(0, 68, 124, 0.2);
            outline: none;
        }
        .grid-calc {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        .grid-calc div label {
            font-weight: bold;
            color: var(--color-principal);
            margin-bottom: 5px;
            display: block;
        }

        /* Estilos de botones espec√≠ficos */
        button.save-btn { background: var(--color-exito); border-color: var(--color-exito); }
        button.save-btn:hover { background: #218838; }
        button.import-btn { background: var(--color-advertencia); border-color: var(--color-advertencia); }
        button.import-btn:hover { background: #cf6e1f; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: var(--color-fondo-claro);
            border-radius: 8px;
            overflow: hidden; /* Para bordes redondeados */
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: left;
            font-size: 0.95em;
        }
        th {
            background: var(--color-principal);
            color: var(--color-fondo-claro);
            font-weight: bold;
            text-transform: uppercase;
        }
        tr:nth-child(even) { background-color: #f9f9f9; } /* Rayas cebra para legibilidad */
        tr:hover { background-color: #f0f8ff; } /* Efecto hover en filas */
        
        .sync-status { font-size: 0.8rem; color: var(--color-exito); text-align: center; margin-top: 10px; }
        
        @media (max-width: 768px) {
            header h1 { font-size: 1.8em; }
            header img { height: 45px; margin-right: 10px; }
            .nav-bar { flex-direction: column; gap: 8px; }
            .nav-bar button { min-width: unset; width: 100%; }
            .grid-calc { grid-template-columns: 1fr; }
            .container { padding: 15px; }
            .card { padding: 18px; }
        }
        @media (max-width: 480px) {
            header h1 { font-size: 1.5em; }
            header p { font-size: 0.9em; }
            header img { height: 40px; }
            th, td { padding: 10px; font-size: 0.9em; }
        }
        .bold-cell {
            font-weight: bold;
        }

        /* Panel log√≠stico: tarjetas por material (legible en obra) */
        .logistica-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .mat-item {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border-top: 4px solid var(--color-principal);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .mat-item span { display: block; font-size: 1.5em; font-weight: bold; color: var(--color-principal); }
        .mat-item label { font-size: 0.8em; color: #666; text-transform: uppercase; }

        /* Estilos para inputs editables dentro de la tabla */
        .input-editable {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-family: inherit;
            font-size: 0.9em;
            background-color: #fff9e6; /* tono amarillo suave para indicar editable */
        }

        .input-editable:focus {
            border-color: var(--color-resaltar);
            outline: none;
            background-color: #fff;
        }

        tr:hover .input-editable {
            border-color: var(--color-principal);
        }

        /* Additional mobile fine-tuning */
        @media (max-width: 360px) {
            header { padding: 0.8rem 0.6rem; }
            header img { height: 36px; margin-right: 8px; }
            header h1 { font-size: 1.25rem; }
            header p { font-size: 0.75rem; }
            .nav-bar { padding: 6px; gap:6px; }
            .nav-bar button { padding: 8px; font-size: 0.85rem; }
            .grid-calc { gap: 12px; }
            .grid-calc div label { font-size: 0.9em; }
            .form-input { padding: 10px; }
            .card { padding: 12px; }
            th, td { font-size: 0.82rem; padding: 8px; }
            .mat-item span { font-size: 1.15em; }
        }

        @media (max-width: 320px) {
            header h1 { font-size: 1.05rem; }
            .nav-bar { gap:4px; }
            .nav-bar button { padding: 6px; font-size: 0.8rem; }
            .grid-calc { grid-template-columns: 1fr; gap:10px; }
            .logistica-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            /* Allow table container to scroll horizontally on very small screens */
            .card[style*="overflow-x: auto"] { -webkit-overflow-scrolling: touch; }
            #tablaPresupuesto { min-width: 760px; }
        }
    </style>
</head>
<body>

<header>
    <img src="logo.png" alt="Logo CONSTRUCTORA WM/M&S">
    <div>
        <h1>CONSTRUCTORA WM/M&S</h1>
        <p><i>"CONSTRUYENDO EL FUTURO"</i></p>

    <!-- seccionMateriales moved to main container for better layout -->
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div class="wm-tooltip">
            <button id="globalCompactBtnCalc" class="compact-toggle-global" onclick="syncCompactGlobal()">üåê Compacta Global</button>
            <div class="wm-tooltip-text">Sincroniza la vista compacta en todas las p√°ginas. Oculta columnas menos relevantes y mejora legibilidad en m√≥viles.</div>
        </div>
        <div class="wm-tooltip">
            <button id="configCompactCalc" class="compact-toggle-global" onclick="openCompactConfig()">‚öôÔ∏è Config</button>
            <div class="wm-tooltip-text">Configurar qu√© columnas se ocultan en la Vista Compacta para esta p√°gina.</div>
        </div>
    </div>
</header>
 
    <div style="display: flex; gap: 10px; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="location.href='index.html'" style="background: var(--p); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-home"></i> INICIO (Finanzas)
    </button>
    <button onclick="location.href='proyectos.html'" style="background: var(--p); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-folder"></i> HISTORIAL
    </button>
    <button id="compactToggle" class="compact-toggle" onclick="toggleCompactView()" title="Vista compacta">üóÇÔ∏è Vista Compacta</button>
</div>

    <div class="nav-bar">
    <button onclick="window.location.href='index.html'">üè† Inicio</button>
    <button onclick="window.location.href='proyectos.html'">üìÇ Proyectos</button>
        <button onclick="window.location.href='guia.html'">üìò Gu√≠a Acabados 2026</button>
        <button onclick="window.location.href='orden_compra_tecnica.html'">üßæ Orden Compra</button>
    <button onclick="exportPDF()">üìÑ PDF</button>
    <button onclick="exportCSV()">üìä Exportar CSV</button>
    <button onclick="exportarMaterialesCSV()">üì¶ Exportar Materiales CSV</button>
    <button onclick="exportarMaterialesPDF()">üì¶ Exportar Materiales PDF</button>
        <button class="import-btn" onclick="document.getElementById('importarInput').click()">üì• Importar CSV</button>
        <input type="file" id="importarInput" style="display:none" accept=".csv" onchange="importarCSV(this)">
        <button class="import-btn" onclick="document.getElementById('importRenglonesInput').click()">‚ûï Importar Renglones</button>
        <input type="file" id="importRenglonesInput" style="display:none" accept=".json,.csv,.txt" onchange="importarRenglones(this)">
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:8px;color:var(--color-principal);font-weight:bold;">Key:</label>
        <select id="renglonesKeySelect" onchange="changeRenglonesKey(this.value)" title="Seleccionar key storage"> 
            <option value="renglones_base">renglones_base</option>
            <option value="proyectos">proyectos</option>
        </select>
</div>

<div class="container">
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <select id="calcProjectSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ddd;" title="Seleccionar proyecto"></select>
        <button onclick="injectSelectedProjectM2()" style="padding:8px 10px; background:#00447C; color:#fff; border-radius:6px; border:none;">Inyectar m¬≤</button>
        <button onclick="openSelectedProjectInUI()" style="padding:8px 10px; background:#17a2b8; color:#fff; border-radius:6px; border:none;">Abrir en Calculadora</button>
    </div>
    <div class="card" style="background: #f8f9fa; border-left: 5px solid var(--color-resaltar);">
        <h3 onclick="document.getElementById('panelPrecios').style.display = document.getElementById('panelPrecios').style.display === 'none' ? 'grid' : 'none'" style="cursor:pointer;">
            ‚öôÔ∏è Ajustar Precios de Insumos (Click para abrir)
        </h3>
        <div id="panelPrecios" class="grid-calc" style="display:none;">
            <div>
                <label>Saco Cemento (Q):</label>
                <input type="number" id="p_cemento" value="85" oninput="actualizarPreciosBase()">
            </div>
            <div>
                <label>Quintal Hierro (Q):</label>
                <input type="number" id="p_hierro" value="385" oninput="actualizarPreciosBase()">
            </div>
            <div>
                <label>Unidad de Block (Q):</label>
                <input type="number" id="p_block" value="4.50" step="0.01" oninput="actualizarPreciosBase()">
            </div>
            <div>
                <label>Metro Arena (Q):</label>
                <input type="number" id="p_arena" value="150" oninput="actualizarPreciosBase()">
            </div>
            <div style="display:flex;align-items:center;">
                <button id="applyPricesBtn" onclick="aplicarPreciosMaestros()" style="background:#00447C;color:#fff;padding:10px;border-radius:6px;border:none;font-weight:bold;width:100%;">Aplicar Precios Maestros a Base</button>
            </div>
        </div>
    </div>
    <div class="card">
        <h3>Calculadora de Materiales y Presupuesto Maestro</h3>
        <div class="grid-calc">
            <div>
                <label for="tipoObra">Tipolog√≠a de Obra:</label><br>
                <select id="tipoObra" onchange="cargarRenglones()" title="Tipolog√≠a de Obra">
                    <option value="residencial">Uso Residencial</option>
                    <option value="comercial">Uso Comercial</option>
                    <option value="industrial">Uso Industrial</option>
                    <option value="civil">Obra Civil</option>
                    <option value="publica">Obra P√∫blica</option>
                </select>
            </div>
            <!-- Los tipos de losa y techo se obtienen desde `visita_campo` y no se solicitan aqu√≠ para evitar duplicaci√≥n -->
            <div>
                <label for="cubiertaProyecto">Cubierta (Visita Campo):</label><br>
                <input type="text" id="cubiertaProyecto" placeholder="(se completa al abrir proyecto)" readonly style="background:#f3f3f3;" title="Tipo de cubierta capturado en Visita Campo">
            </div>
            <div>
                <label for="cantidadGlobal">√Årea a Construir ($m^2$):</label><br>
                <input type="number" id="cantidadGlobal" value="100" oninput="cargarRenglones()" placeholder="Ingrese el √°rea en m¬≤" title="√Årea a Construir en metros cuadrados">
            </div>
            <div>
                <label>Nombre del Proyecto:</label><br>
                <input type="text" id="nombreProyecto" placeholder="Ej. Casa Bosques">
            </div>
        </div>
        <button onclick="guardarLocal()" style="background: #28a745;">üíæ Guardar en Dispositivo</button>
    </div>

    <div class="card">
        <h3 style="color: var(--color-principal); border-bottom: 2px solid var(--color-resaltar);">üöõ LOG√çSTICA DE COMPRA (Estimados)</h3>
        <div id="resumenMateriales" class="logistica-grid"></div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">*Cantidades estimadas para compra inicial. Incluyen factor de desperdicio del 5%.</p>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
                <button onclick="exportarMaterialesCSV()" style="width:100%; padding:10px; font-weight:bold;">üì¶ Exportar Materiales CSV</button>
            </div>
            <div style="flex:1; min-width:200px;">
                <button onclick="exportarMaterialesPDF()" style="width:100%; padding:10px; font-weight:bold;">üì¶ Exportar Materiales PDF</button>
            </div>
            <div style="flex:1; min-width:240px;">
                <button onclick="enviarWhatsApp()" style="background-color: #25D366; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                    Enviar Pedido por WhatsApp
                </button>
            </div>
            <div style="flex:1; min-width:200px;">
                <button onclick="generarOrdenCompra()" style="width:100%; padding:10px; font-weight:bold; background:#00447C; color:#fff; border:none; border-radius:6px;">üßæ Generar Orden Compra</button>
            </div>
        </div>
    </div>
    <div style="margin-bottom:24px;">
        <label for="waPhone" style="font-weight:bold; display:block; margin-bottom:6px;">N√∫mero de proveedor (WhatsApp) ‚Äî incluir c√≥digo de pa√≠s, p.ej. 50212345678</label>
        <input id="waPhone" placeholder="50212345678" style="padding:10px; width:320px; max-width:100%; border-radius:6px; border:1px solid #ccc;" />
    </div>

    <div class="card" style="overflow-x: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap:10px;">
            <h3 style="flex:1;">Detalle del Presupuesto (Costo Directo)</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <button onclick="addCustomRenglon()" title="Agregar rengl√≥n personalizado" style="background:#17a2b8;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:0.9em;">‚ûï Agregar Rengl√≥n</button>
                <button onclick="resetearCantidades()" style="background: var(--color-advertencia); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; font-weight: bold;">
                    üîÑ Resetear a Estimados
                </button>
            </div>
        </div>
        <table id="tablaPresupuesto">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Rengl√≥n Cronol√≥gico</th>
                    <th>Unidad</th>
                    <th>Cant. Estimada</th>
                    <th>Costo Unit. (Q)</th>
                    <th>Subtotal (Q)</th>
                    <th>Materiales Clave / Notas</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla">
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" style="text-align: right; font-weight: bold;">TOTAL COSTO DIRECTO:</td>
                    <td id="totalCostoDirecto" style="font-weight: bold;">Q 0.00</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="5" style="text-align: right; font-weight: bold;">COSTOS INDIRECTOS (15%):</td>
                    <td id="costoIndirecto" class="bold-cell">Q 0.00</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="5" style="text-align: right; font-weight: bold;">IMPREVISTOS (5%):</td>
                    <td id="costoImprevisto" style="font-weight: bold;">Q 0.00</td>
                    <td></td>
                </tr>
                 <tr>
                    <td colspan="5" style="text-align: right; font-weight: bold;">UTILIDAD WM (12%):</td>
                    <td id="costoUtilidad" style="font-weight: bold;">Q 0.00</td>
                    <td></td>
                </tr>
                <tr style="background: var(--color-resaltar); color: var(--color-principal);">
                    <td colspan="5" style="text-align: right; font-weight: bold;">PRECIO DE VENTA TOTAL:</td>
                    <td id="precioVentaTotal" style="font-weight: bold;">Q 0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
        // load shared script for global sync
        (function(){ var s=document.createElement('script'); s.src='js/common-responsive.js'; document.head.appendChild(s); })();
    // BASE DE DATOS DE RENGLONES Y PAR√ÅMETROS
    const baseDatos = {
        residencial: [
            { n: "Limpieza y Descapote", u: "m2", c: 1.0, p: 15, m: "Herramienta menor", r: "25 m¬≤/d√≠a" },
            { n: "Trazo y Niveles", u: "m2", c: 1.0, p: 18, m: "Cal, estacas, hilos", r: "45 m¬≤/d√≠a" },
            { n: "Excavaci√≥n Cimiento", u: "m3", c: 0.1, p: 95, m: "Manual (suelo semiduro)", r: "4 m¬≥/d√≠a" },
            { n: "Cimiento Corrido (0.4x0.2m)", u: "ml", c: 1.0, p: 285, m: "Hierro 3/8, Cemento 3k PSI", r: "7 ml/d√≠a" },
            { n: "Levantado Sobrecimiento", u: "m2", c: 0.8, p: 145, m: "Block 14cm, mortero", r: "13 m¬≤/d√≠a" },
            { n: "Solera Hidr√≥fuga", u: "ml", c: 0.8, p: 130, m: "Aditivo imperm., conc.", r: "11 ml/d√≠a" },
            { n: "Drenajes PVC (4', 2')", u: "ml", c: 1.2, p: 115, m: "Tuber√≠a, accesorios, pegamento", r: "15 ml/d√≠a" },
            { n: "Relleno Compactado Selecto", u: "m3", c: 0.2, p: 220, m: "Material selecto, agua", r: "7 m¬≥/d√≠a" },
            { n: "Contrapiso (e=0.07m)", u: "m2", c: 1.0, p: 98, m: "Concreto 2k PSI", r: "28 m¬≤/d√≠a" },
            { n: "Levantado Muros Block (14cm)", u: "m2", c: 2.5, p: 155, m: "Block 14cm, mortero 1:4", r: "14 m¬≤/d√≠a" },
            { n: "Columnas y Pines", u: "unid", c: 0.1, p: 450, m: "Acero 3/8, conc. 3k PSI", r: "3.5 unid/d√≠a" },
            { n: "Solera Intermedia", u: "ml", c: 1.5, p: 110, m: "Acero 3/8, conc. 3k PSI", r: "15 ml/d√≠a" },
            { n: "Solera de Corona", u: "ml", c: 1.0, p: 145, m: "Acero 3/8, conc. 3k PSI", r: "10 ml/d√≠a" },
            { n: "Sillares y Dinteles", u: "ml", c: 0.5, p: 120, m: "Acero, conc. para vanos", r: "6 ml/d√≠a" },
            { n: "Encofrado Losa (Obra Falsa)", u: "m2", c: 1.0, p: 65, m: "Madera, parales, desmoldante", r: "18 m¬≤/d√≠a" },
            { n: "Ducter√≠a El√©ctrica en Losa", u: "salida", c: 0.8, p: 260, m: "Poliducto, cajas, alambres", r: "9 sal/d√≠a" },
            { n: "Armado Losa (Vigueta/Bovedilla)", u: "m2", c: 1.0, p: 320, m: "Viguetas, bovedillas, malla", r: "15 m¬≤/d√≠a" },
            { n: "Fundici√≥n Capa Losa (e=5cm)", u: "m2", c: 1.0, p: 195, m: "Concreto 3k PSI (premezclado)", r: "35 m¬≤/d√≠a" },
            { n: "Curado de Concreto", u: "m2", c: 1.0, p: 15, m: "Agua (durante 7 d√≠as)", r: "Global" },
            { n: "Red Agua Potable (CPVC)", u: "punto", c: 0.6, p: 480, m: "Tuber√≠a, fittings, pegamento", r: "4 ptos/d√≠a" },
            { n: "Repello de Muros (Interior)", u: "m2", c: 2.5, p: 85, m: "Mortero 1:3 Cemento-Arena", r: "20 m¬≤/d√≠a" },
            { n: "Cernido Fino (Interior)", u: "m2", c: 2.5, p: 65, m: "Mortero 1:5 Cemento-Cal-Arena", r: "22 m¬≤/d√≠a" },
            { n: "Repello y Cernido (Exterior)", u: "m2", c: 1.2, p: 160, m: "Mortero 1:3 y 1:5", r: "18 m¬≤/d√≠a" },
            { n: "Impermeabilizaci√≥n Losa/Techo", u: "m2", c: 1.0, p: 95, m: "Manta asf√°ltica o l√≠quido", r: "40 m¬≤/d√≠a" },
            { n: "Cielo Falso Drywall/PVC", u: "m2", c: 1.0, p: 145, m: "Perfiles, l√°minas, tornillos", r: "16 m¬≤/d√≠a" },
            { n: "Piso Cer√°mico (40x40cm)", u: "m2", c: 1.0, p: 165, m: "Cer√°mica, pegamix, sisa", r: "11 m¬≤/d√≠a" },
            { n: "Azulejo en Ba√±os/Cocinas", u: "m2", c: 0.5, p: 185, m: "Azulejo, pegamento, boquilla", r: "7 m¬≤/d√≠a" },
            { n: "Ventaner√≠a Aluminio (Est√°ndar)", u: "m2", c: 0.3, p: 750, m: "Marco, vidrio 5mm, sellador", r: "4 unid/d√≠a" },
            { n: "Puertas Interiores (MDF)", u: "unid", c: 0.08, p: 1250, m: "Puerta, marco, chapa", r: "3 unid/d√≠a" },
            { n: "Pintura L√°tex (2 manos)", u: "m2", c: 4.0, p: 45, m: "Sellador, pintura gal√≥n", r: "45 m¬≤/d√≠a" },
            { n: "Artefactos Sanitarios (Juego)", u: "juego", c: 0.02, p: 2200, m: "Inodoro, lavamanos, ducha", r: "2 juegos/d√≠a" },
            { n: "Instalaci√≥n El√©ctrica Final", u: "punto", c: 0.8, p: 285, m: "Tomas, switches, l√°mparas", r: "18 ptos/d√≠a" },
            { n: "Gabinetes de Cocina (B√°sico)", u: "ml", c: 0.2, p: 1800, m: "Melamina, herrajes", r: "1 ml/d√≠a" },
            { n: "Port√≥n y Herrer√≠a Exterior", u: "m2", c: 0.05, p: 850, m: "Metal, pintura anticorrosiva", r: "1 m¬≤/d√≠a" },
            { n: "Limpieza Final de Obra", u: "m2", c: 1.0, p: 25, m: "Removedores, limpieza profunda", r: "55 m¬≤/d√≠a" },
            // Desde DB externa: renglones a√±adidos si no existen exactamente
            { n: "Losa Vigueta/Bovedilla", u: "m2", c: 1.0, p: 320, m: "Viguetas y bovedillas" }
        ],
        // A√±adidos desde DB externa (evitar duplicados exactos por nombre)
        
        comercial: [
            { n: "Movimiento de Tierras Masivo", u: "m3", c: 0.5, p: 85, m: "Excavadora, camiones", r: "100 m¬≥/d√≠a" },
            { n: "Compactaci√≥n Masiva (Rodillo)", u: "m2", c: 1.0, p: 30, m: "Rodillo vibratorio, agua", r: "500 m¬≤/d√≠a" },
            { n: "Fundaci√≥n (Zapatas Aisladas)", u: "unid", c: 0.1, p: 1200, m: "Acero 1/2, Concreto 4k PSI", r: "5 unid/d√≠a" },
            { n: "Columnas Estructurales (C2)", u: "unid", c: 0.05, p: 850, m: "Acero 5/8, Concreto 4k PSI", r: "2 unid/d√≠a" },
            { n: "Estructura Met√°lica (Naves)", u: "lb", c: 45, p: 12, m: "Vigas H, soldadura, pernos", r: "2000 lbs/d√≠a" },
            { n: "Muro Cortafuego (Block/Panel)", u: "m2", c: 1.5, p: 350, m: "Panel RF o Block con relleno", r: "10 m¬≤/d√≠a" },
            { n: "Techo de L√°mina Aluzinc (TR-4)", u: "m2", c: 1.0, p: 180, m: "L√°mina, estructura met√°lica L", r: "50 m¬≤/d√≠a" },
            { n: "Piso Industrial (Endurecido)", u: "m2", c: 1.0, p: 210, m: "Concreto 3k PSI, endurecedor, fibra", r: "30 m¬≤/d√≠a" },
            { n: "Instalaci√≥n El√©ctrica Trif√°sica", u: "punto", c: 0.2, p: 750, m: "Cable THW, tuber√≠a EMT, breakers", r: "5 ptos/d√≠a" },
            { n: "Tableros El√©ctricos y Subestaci√≥n", u: "unid", c: 0.01, p: 8500, m: "Tablero, barras, medidor", r: "1 unid/2 d√≠as" },
            { n: "Red Hidr√°ulica (Acero Galvanizado)", u: "ml", c: 0.5, p: 250, m: "Tuber√≠a HG, v√°lvulas", r: "10 ml/d√≠a" },
            { n: "Drenajes PVC (6', 8')", u: "ml", c: 0.8, p: 180, m: "Tuber√≠a, pozos de visita", r: "8 ml/d√≠a" },
            { n: "Sistema Contra Incendios (Anillos)", u: "ml", c: 0.1, p: 450, m: "Tuber√≠a roja, sprinklers, bomba", r: "5 ml/d√≠a" },
            { n: "Oficinas Administrativas (Tablaroca)", u: "m2", c: 0.3, p: 180, m: "Tablaroca, perfiles, tornillos", r: "15 m¬≤/d√≠a" },
            { n: "Cielo Falso Ac√∫stico (2x4)", u: "m2", c: 0.8, p: 120, m: "Perfiler√≠a, paneles ac√∫sticos", r: "20 m¬≤/d√≠a" },
            { n: "Pintura Ep√≥xica de Pisos", u: "m2", c: 1.0, p: 90, m: "Imprimante, pintura ep√≥xica (2 manos)", r: "40 m¬≤/d√≠a" },
            { n: "Andenes de Carga (Rampa Concreto)", u: "ml", c: 0.05, p: 2500, m: "Concreto, acero, defensas", r: "0.5 ml/d√≠a" },
            { n: "Instalaci√≥n de Montacargas", u: "unid", c: 0.01, p: 15000, m: "Equipo, adecuaci√≥n", r: "Global" },
            { n: "Ventilaci√≥n Industrial (Extractores)", u: "unid", c: 0.05, p: 1800, m: "Extractores e√≥licos/el√©ctricos", r: "2 unid/d√≠a" },
            { n: "Ventaner√≠a Comercial (Vidrio Temp.)", u: "m2", c: 0.2, p: 900, m: "Vidrio templado, aluminio anodizado", r: "2 m¬≤/d√≠a" },
            { n: "Puertas de Emergencia (Cortafuego)", u: "unid", c: 0.02, p: 1800, m: "Puerta RF, barra antip√°nico", r: "1 unid/d√≠a" },
            { n: "Se√±alizaci√≥n Interna/Externa", u: "unid", c: 0.1, p: 350, m: "Se√±ales de seguridad, extintores", r: "10 unid/d√≠a" },
            { n: "Cerramiento Perimetral (Muro/Malla)", u: "ml", c: 0.5, p: 220, m: "Block, malla cicl√≥n, concertina", r: "15 ml/d√≠a" },
            { n: "Garita de Seguridad", u: "unid", c: 0.01, p: 12000, m: "Block, losa, ventanas, puerta", r: "Global" },
            { n: "Portones Industriales (Corredizos)", u: "unid", c: 0.01, p: 7000, m: "Estructura met√°lica, motor", r: "1 unid/2 d√≠as" },
            { n: "Iluminaci√≥n Industrial (Led Alta B.)", u: "punto", c: 0.3, p: 450, m: "Luminarias LED, cableado", r: "8 ptos/d√≠a" },
            { n: "Sistema de C√°maras (CCTV)", u: "punto", c: 0.1, p: 600, m: "C√°maras, DVR, cableado", r: "5 ptos/d√≠a" },
            { n: "Jardinizacion y √Åreas Verdes", u: "m2", c: 0.1, p: 40, m: "Tierra negra, plantas, grama", r: "50 m¬≤/d√≠a" },
            { n: "Parqueo (Asfalto/Concreto)", u: "m2", c: 0.5, p: 150, m: "Base granular, asfalto/concreto", r: "100 m¬≤/d√≠a" },
            { n: "Pintura Exterior (Base Elastom√©rica)", u: "m2", c: 1.0, p: 70, m: "Pintura industrial, andamios", r: "30 m¬≤/d√≠a" },
            { n: "Limpieza Final de Naves", u: "m2", c: 1.0, p: 30, m: "Limpieza profunda de estructuras", r: "100 m¬≤/d√≠a" }
        ],
        // A√±adidos industriales desde DB externa
        
        industrial: [
            { n: "Cimentaci√≥n de Maquinaria Pesada", u: "m3", c: 0.05, p: 1800, m: "Concreto 5k PSI, anclajes", r: "1 m¬≥/d√≠a" },
            { n: "Losa Postensada", u: "m2", c: 0.01, p: 600, m: "Concreto, torones, anclajes", r: "5 m¬≤/d√≠a" },
            { n: "Estructura para Gr√∫as Puente", u: "ton", c: 0.005, p: 2500, m: "Acero estructural A36, soldadura", r: "0.1 ton/d√≠a" },
            { n: "Cubierta Tipo Sandwich Panel", u: "m2", c: 1.0, p: 280, m: "Panel aislante, remates", r: "30 m¬≤/d√≠a" },
            { n: "Sistemas de Evacuaci√≥n de Humos", u: "unid", c: 0.01, p: 4500, m: "Campanas, ductos, extractores", r: "Global" },
            { n: "Instalaciones de Aire Comprimido", u: "ml", c: 0.5, p: 180, m: "Tuber√≠a galvanizada, compresor", r: "10 ml/d√≠a" },
            { n: "Red de Tierras Industriales", u: "punto", c: 0.05, p: 800, m: "Electrodos, cableado, puestas a tierra", r: "2 ptos/d√≠a" },
            { n: "Protecci√≥n Cat√≥dica", u: "ml", c: 0.01, p: 1200, m: "√Ånodos de sacrificio, cableado", r: "Global" },
            { n: "Tanques de Almacenamiento (Concreto)", u: "m3", c: 0.001, p: 5000, m: "Concreto armado, recubrimiento ep√≥xico", r: "Global" },
            { n: "Tratamiento de Aguas Residuales Industriales", u: "m3/d√≠a", c: 0.001, p: 25000, m: "Filtros, bombas, qu√≠micos", r: "Global" },
            { n: "Cercado de Seguridad con Sensores", u: "ml", c: 0.05, p: 350, m: "Malla, sensores infrarrojos, concertina", r: "8 ml/d√≠a" },
            { n: "Puertas R√°pidas Industriales", u: "unid", c: 0.01, p: 6000, m: "Puerta enrollable, motor", r: "Global" },
            { n: "Aislamiento Ac√∫stico de √Åreas", u: "m2", c: 0.05, p: 400, m: "Paneles aislantes, barreras de sonido", r: "10 m¬≤/d√≠a" },
            { n: "Piso Antiest√°tico ESD", u: "m2", c: 0.01, p: 250, m: "Recubrimiento ep√≥xico conductivo", r: "20 m¬≤/d√≠a" },
            { n: "Sistema de Gesti√≥n de Edificios (BMS)", u: "punto", c: 0.001, p: 15000, m: "Controladores, sensores, integraciones", r: "Global" },
            { n: "Transformador y Tablero MT/BT", u: "unid", c: 0.005, p: 25000, m: "Transformador, tablero, protecciones", r: "Global" },
            { n: "Sistemas Anti-Incendio Industriales", u: "punto", c: 0.02, p: 2000, m: "Sprinklers, bombas, tuber√≠a", r: "5 ptos/d√≠a" },
            { n: "Sistema de Extracci√≥n y Filtrado", u: "unid", c: 0.01, p: 8000, m: "Ventiladores, filtros, ductos", r: "Global" },
            { n: "Linea de Tuber√≠as Qu√≠micas", u: "ml", c: 0.2, p: 600, m: "Tuber√≠a especial, juntas", r: "10 ml/d√≠a" },
            { n: "Recubrimiento Ep√≥xico de Superficies", u: "m2", c: 1.0, p: 120, m: "Epoxy, imprimante", r: "50 m¬≤/d√≠a" },
            { n: "Sistemas PLC y SCADA", u: "punto", c: 0.001, p: 12000, m: "PLC, pantallas HMI, comunicaciones", r: "Global" },
            { n: "Iluminaci√≥n de Alta Bah√≠a (LED)", u: "punto", c: 0.2, p: 750, m: "Luminarias LED, soporte", r: "20 ptos/d√≠a" },
            { n: "Canalizaciones y Bandejas", u: "ml", c: 0.5, p: 90, m: "Bandejas de cable, fijaciones", r: "50 ml/d√≠a" },
            { n: "Montaje de Equipos Mec√°nicos", u: "unid", c: 0.01, p: 9000, m: "Estructuras, anclajes", r: "Global" },
            { n: "Pruebas y Puesta en Marcha", u: "servicio", c: 1.0, p: 2500, m: "Mano de obra especializada", r: "Global" },
            { n: "Protecciones y Se√±alizaci√≥n Industrial", u: "unid", c: 0.1, p: 450, m: "Bollards, se√±ales, barreras", r: "10 unid/d√≠a" },
            { n: "Obras Complementarias (Oficinas)", u: "m2", c: 0.5, p: 320, m: "Acabados, divisiones", r: "20 m¬≤/d√≠a" },
            { n: "Sistemas de Tratamiento de Aire (AHU)", u: "unid", c: 0.01, p: 8000, m: "AHU, conductos, control", r: "Global" }
        ,
            // Desde DB externa: a√±adir exactos faltantes
            { n: "Estructura Met√°lica H", u: "ton", c: 0.005, p: 2500, m: "Acero A36" },
            { n: "Piso Ep√≥xico ESD", u: "m2", c: 1.0, p: 250, m: "Resina conductiva" },
            { n: "Extractores E√≥licos", u: "unid", c: 0.02, p: 1800, m: "Extractores e√≥licos" },
            { n: "Instalaci√≥n Aire Comprimido", u: "ml", c: 0.5, p: 180, m: "Tuber√≠a galvanizada" }
        ],
        civil: [
            { n: "Excavaci√≥n para Tuber√≠a", u: "m3", c: 0.25, p: 95, m: "Zanja para red hidr√°ulica" },
            { n: "Capa de Base Granular", u: "m3", c: 0.15, p: 220, m: "Material clasificado compactado" },
            { n: "Pavimento Hidr√°ulico t=15cm", u: "m2", c: 1.0, p: 285, m: "Concreto 4000 PSI reforzado" },
            { n: "Bordillo Tipo A", u: "ml", c: 0.2, p: 135, m: "Fundido en sitio" },
            { n: "Movimientos de Tierra (Excavaci√≥n)", u: "m3", c: 0.5, p: 60, m: "Maquinaria, camiones", r: "500 m¬≥/d√≠a" },
            { n: "Sub-Base Granular", u: "m2", c: 0.5, p: 45, m: "Material granular, compactacion", r: "300 m¬≤/d√≠a" },
            { n: "Base de Concreto Hidr√°ulico", u: "m3", c: 0.02, p: 420, m: "Concreto, vibrado", r: "20 m¬≥/d√≠a" },
            { n: "Estructuras de Drenaje (Aletas)", u: "ml", c: 0.4, p: 160, m: "Tuber√≠a, c√°maras", r: "30 ml/d√≠a" },
            { n: "Muros de Contenci√≥n (Hormig√≥n)", u: "m3", c: 0.02, p: 850, m: "Hormig√≥n, encofrado, acero", r: "10 m¬≥/d√≠a" },
            { n: "Puentes Peatonales (Losas)", u: "m2", c: 0.01, p: 950, m: "Losas, armaduras", r: "10 m¬≤/d√≠a" },
            { n: "Cunetas y Alcantarillas", u: "ml", c: 0.6, p: 85, m: "Tuber√≠a, concreto prefabricado", r: "80 ml/d√≠a" },
            { n: "Pavimento Asf√°ltico (Capas)", u: "m2", c: 0.8, p: 120, m: "Asfalto, rodillo", r: "200 m¬≤/d√≠a" },
            { n: "Se√±alizaci√≥n Vial Horizontal", u: "m2", c: 0.02, p: 35, m: "Pintura termopl√°stica", r: "500 m¬≤/d√≠a" },
            { n: "Iluminaci√≥n Vial", u: "unid", c: 0.02, p: 1450, m: "Postes, luminarias LED", r: "5 unid/d√≠a" },
            { n: "Paso a Nivel / Accesos", u: "ml", c: 0.05, p: 320, m: "Base, pavimento", r: "20 ml/d√≠a" },
            { n: "Red de Agua Potable (Mayor)", u: "ml", c: 0.6, p: 300, m: "Tuber√≠a DI/HDPE", r: "60 ml/d√≠a" },
            { n: "Estaciones de Bombeo", u: "unid", c: 0.01, p: 12000, m: "Bomba, tuberia", r: "Global" },
            { n: "Estabilizacion de Taludes", u: "m2", c: 0.2, p: 180, m: "Geomalla, anclajes", r: "50 m¬≤/d√≠a" },
            { n: "Tendidos de Pavimento Rigido (Losas)", u: "m2", c: 0.5, p: 260, m: "Concreto, juntas", r: "80 m¬≤/d√≠a" },
            { n: "Se√±ales Verticales y Sem√°foros", u: "unid", c: 0.02, p: 750, m: "Estructura, luminaria", r: "5 unid/d√≠a" },
            { n: "Muros de Gabion", u: "m3", c: 0.02, p: 220, m: "Gabion, piedra", r: "15 m¬≥/d√≠a" },
            { n: "Obras de Arte (Acueductos)", u: "unid", c: 0.01, p: 18000, m: "Estructura, bomba", r: "Global" },
            { n: "Rehabilitaci√≥n Estructural", u: "m2", c: 0.2, p: 320, m: "Refuerzo, epoxis", r: "30 m¬≤/d√≠a" },
            { n: "Protectores de Talud Vegetal", u: "m2", c: 0.1, p: 45, m: "Malla, vegetacion", r: "100 m¬≤/d√≠a" },
            { n: "Redes Pluviales (Alcantarillado)", u: "ml", c: 0.6, p: 160, m: "Tuber√≠a, sumideros", r: "60 ml/d√≠a" },
            { n: "Control Geotecnico y Ensayos", u: "global", c: 1.0, p: 2500, m: "Ensayos, laboratorio", r: "Global" },
            { n: "Sistemas de Riego y Parques", u: "m2", c: 0.05, p: 55, m: "Tubos, aspersores", r: "200 m¬≤/d√≠a" },
            { n: "Cimentaciones Especiales (Pilotes)", u: "ml", c: 0.02, p: 950, m: "Pilotes, perforacion", r: "5 ml/d√≠a" },
            { n: "Pasos Peatonales y Accesos", u: "m2", c: 0.5, p: 120, m: "Concreto, acabados", r: "150 m¬≤/d√≠a" },
            { n: "Mobiliario Urbano (Bancos/Lumin.)", u: "unid", c: 0.02, p: 450, m: "Fabricacion, instalacion", r: "20 unid/d√≠a" },
            { n: "Se√±alizaci√≥n y Seguridad Vial", u: "unid", c: 0.05, p: 150, m: "Se√±ales, defensas", r: "50 unid/d√≠a" },
            { n: "Obras de Cruce y Pasos Inferiores", u: "unid", c: 0.005, p: 45000, m: "Estructura, excavacion", r: "Global" },
            { n: "Revestimiento y Protecci√≥n de Riberas", u: "m2", c: 0.1, p: 220, m: "Geotextil, roca", r: "75 m¬≤/d√≠a" },
            { n: "Limpieza y Se√±alizacion Final", u: "m2", c: 1.0, p: 25, m: "Limpieza, se√±alizacion", r: "500 m¬≤/d√≠a" }
        ,
            { n: "Cunetas de Concreto", u: "ml", c: 0.2, p: 210, m: "Concreto 3k PSI" },
            { n: "Bordillos Prefabricados", u: "ml", c: 0.2, p: 145, m: "Concreto de alta resistencia" },
            { n: "Pozos de Visita", u: "unid", c: 0.01, p: 4500, m: "Ladrillo y tapadera fundici√≥n" },
            { n: "Asfalto en Caliente (10cm)", u: "m2", c: 1.0, p: 195, m: "Mezcla asf√°ltica" }
        ],
        // Desde DB externa: entradas civiles exactas faltantes
        
        publica: [
            { n: "Instalaci√≥n de Postes", u: "unid", c: 0.02, p: 1200, m: "Excavaci√≥n y fundici√≥n de base" },
            { n: "Juegos Infantiles (Set)", u: "global", c: 0.01, p: 45000, m: "Suministro e instalaci√≥n" },
            { n: "Bancas de Parque", u: "unid", c: 0.05, p: 2800, m: "Concreto y madera tratada" },
            { n: "Grama en Rollos", u: "m2", c: 1.0, p: 45, m: "Incluye tierra negra y riego" },
            { n: "Vivienda Social Tipo A", u: "m2", c: 1.0, p: 650, m: "Estructura, acabados b√°sicos", r: "20 m¬≤/d√≠a" },
            { n: "Centro Comunitario (Peque√±o)", u: "m2", c: 1.0, p: 820, m: "Estructura mixto, acabados", r: "25 m¬≤/d√≠a" },
            { n: "Aulas Escolares (Modulo)", u: "m2", c: 1.0, p: 780, m: "Estructura, acabados, ventilacion", r: "30 m¬≤/d√≠a" },
            { n: "Sede de Salud (Puesto)", u: "m2", c: 1.0, p: 900, m: "Acabados, instalaciones medicas basicas", r: "20 m¬≤/d√≠a" },
            { n: "Red de Agua Potable Comunitaria", u: "ml", c: 0.6, p: 220, m: "Tuberia, tanques", r: "40 ml/d√≠a" },
            { n: "Red de Alumbrado P√∫blico", u: "unid", c: 0.02, p: 1200, m: "Poste, luminaria LED", r: "10 unid/d√≠a" },
            { n: "Adoquinado y Pavimento", u: "m2", c: 0.8, p: 140, m: "Base, adoquines", r: "120 m¬≤/d√≠a" },
            { n: "Parques Infantiles (Equipamiento)", u: "unid", c: 0.02, p: 4500, m: "Juegos, piso de seguridad", r: "Global" },
            { n: "Bordillos y Aceras", u: "ml", c: 0.5, p: 65, m: "Concreto, acabados", r: "150 ml/d√≠a" },
            { n: "Puestos de Salud y Atenci√≥n", u: "unid", c: 0.01, p: 28000, m: "Estructura, instalaciones", r: "Global" },
            { n: "Edificios Administrativos Locales", u: "m2", c: 1.0, p: 950, m: "Estructura, acabados", r: "25 m¬≤/d√≠a" },
            { n: "Centros Deportivos (Basico)", u: "m2", c: 1.0, p: 700, m: "Grama sintetica, pistas", r: "50 m¬≤/d√≠a" },
            { n: "Mejoramiento de Plazas y Parques", u: "m2", c: 0.5, p: 120, m: "Pavimentos, jardineria", r: "200 m¬≤/d√≠a" },
            { n: "Obras de Protecci√≥n Social (Refugios)", u: "m2", c: 1.0, p: 620, m: "Estructura basica, cubiertas", r: "20 m¬≤/d√≠a" },
            { n: "Redes de Desag√ºe Pluvial", u: "ml", c: 0.6, p: 140, m: "Tuber√≠a, rejillas", r: "80 ml/d√≠a" },
            { n: "Mejoramiento de Centros Culturales", u: "m2", c: 1.0, p: 780, m: "Acabados, iluminacion", r: "30 m¬≤/d√≠a" },
            { n: "Centros Tecnol√≥gicos (Modulo)", u: "m2", c: 1.0, p: 1100, m: "Instalaciones, redes", r: "25 m¬≤/d√≠a" },
            { n: "Estaciones de Bus (Peque√±as)", u: "unid", c: 0.02, p: 4200, m: "Estructura, cubierta", r: "Global" },
            { n: "Mejoramiento de Mercados Locales", u: "m2", c: 1.0, p: 820, m: "Estructura, acabados comerciales", r: "40 m¬≤/d√≠a" },
            { n: "Mantenimiento de Infraestructura Vial", u: "m2", c: 1.0, p: 95, m: "Reparacion y bacheo", r: "300 m¬≤/d√≠a" },
            { n: "Accesibilidad y Rampas", u: "ml", c: 0.2, p: 110, m: "Concreto, barandas", r: "100 ml/d√≠a" },
            { n: "Canchas Deportivas (Mejora)", u: "m2", c: 1.0, p: 420, m: "Superficie, marquesinas", r: "80 m¬≤/d√≠a" },
            { n: "Se√±alizaci√≥n y Seguridad Publica", u: "unid", c: 0.1, p: 220, m: "Se√±ales, postes", r: "80 unid/d√≠a" },
            { n: "Instalaciones Sanitarias Comunitarias", u: "unid", c: 0.02, p: 3200, m: "Construccion, equipos sanitarios", r: "Global" },
            { n: "Estabilizacion de Suelos y Terraplenes", u: "m2", c: 0.2, p: 160, m: "Geotextiles, compaction", r: "100 m¬≤/d√≠a" },
            { n: "Paisajismo y Mejoras Verdes", u: "m2", c: 0.1, p: 65, m: "Plantas, riego", r: "200 m¬≤/d√≠a" },
            { n: "Iluminaci√≥n Esc√©nica y Monumentos", u: "unid", c: 0.02, p: 950, m: "Luminarias, montaje", r: "10 unid/d√≠a" },
            { n: "M√≥dulos de Seguridad P√∫blica", u: "unid", c: 0.01, p: 14000, m: "Estructura, comunicaciones", r: "Global" },
            { n: "Limpieza y Entrega de Obra P√∫blica", u: "m2", c: 1.0, p: 30, m: "Limpieza, se√±alizacion final", r: "500 m¬≤/d√≠a" },
            { n: "Mobiliario Urbano (Bancas)", u: "unid", c: 0.01, p: 3200, m: "Hierro y madera tratada" },
            { n: "Postes Alumbrado Solar", u: "unid", c: 0.005, p: 8500, m: "Panel 100W, Bater√≠a Litio" },
            { n: "Se√±alizaci√≥n Vial", u: "km", c: 0.001, p: 12000, m: "Pintura termopl√°stica" }
        ]
    };

    // NOTA: se agregaron varios renglones desde el bloque externo (solo si no exist√≠an exactamente).

    // Preferencia de key para persistir renglones (configurable desde UI)
    const RENGLONES_DEFAULT_KEY = 'renglones_base';
    function getRenglonesStorageKey() {
        return localStorage.getItem('RENGLONES_KEY_PREFERENCE') || RENGLONES_DEFAULT_KEY;
    }
    function changeRenglonesKey(val) {
        const oldKey = getRenglonesStorageKey();
        if (oldKey === val) return;
        // Si existe data en la key antigua y no en la nueva, migrar autom√°ticamente
        const oldRaw = localStorage.getItem(oldKey);
        const newRaw = localStorage.getItem(val);
        if (oldRaw && !newRaw) {
            try {
                localStorage.setItem(val, oldRaw);
                localStorage.removeItem(oldKey);
                console.info(`Migrated renglones from ${oldKey} -> ${val}`);
            } catch (e) {
                console.warn('Error migrating renglones key:', e);
            }
        }
        localStorage.setItem('RENGLONES_KEY_PREFERENCE', val);
        // actualizar selector visual
        const sel = document.getElementById('renglonesKeySelect');
        if (sel) sel.value = val;
    }

    // Al cargar la p√°gina: aplicar preferencia de selector y si existe base guardada, fusionar
    (function initRenglonesFromStorage(){
        const sel = document.getElementById('renglonesKeySelect');
        if (sel) sel.value = getRenglonesStorageKey();
        const selectedKey = getRenglonesStorageKey();
        const legacyKey = 'renglones_base';
        // Si hay datos en la key legacy y no en la seleccionada, migrar
        try {
            const legacyRaw = localStorage.getItem(legacyKey);
            const selectedRaw = localStorage.getItem(selectedKey);
            if (legacyRaw && !selectedRaw && legacyKey !== selectedKey) {
                localStorage.setItem(selectedKey, legacyRaw);
                localStorage.removeItem(legacyKey);
                console.info(`Auto-migrated renglones from ${legacyKey} to ${selectedKey}`);
            }
        } catch (e) {
            console.warn('Error during legacy migration:', e);
        }

        const raw = localStorage.getItem(selectedKey);
        if (!raw) return;
        try {
            const parsed = JSON.parse(raw);
            // parsed expected to be same shape as baseDatos
            Object.keys(parsed).forEach(k => {
                if (baseDatos[k]) {
                    mergeRenglonesIntoBase({[k]: parsed[k]});
                } else {
                    baseDatos[k] = parsed[k];
                }
            });
        } catch(e) {
            console.warn('No se pudo parsear baseDatos guardada:', e);
        }
    })();

    /* Utilidades de formateo y animaci√≥n (moneda Q) */
    function formatCurrency(value, decimals = 2) {
        const num = Number(value) || 0;
        try {
            return 'Q ' + num.toLocaleString('es-GT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        } catch (e) {
            return 'Q ' + num.toFixed(decimals);
        }
    }

    function parseCurrency(str) {
        if (str === null || str === undefined) return NaN;
        let s = String(str).trim();
        s = s.replace(/Q|\s|\u00A0/g, '');
        s = s.replace(/[^0-9.,-]/g, '');
        if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
            s = s.replace(/\./g, '').replace(/,/g, '.');
        } else if (s.indexOf(',') !== -1 && s.indexOf('.') === -1) {
            s = s.replace(/,/g, '.');
        }
        const n = Number(s);
        return isNaN(n) ? NaN : n;
    }

    function animateValueChange(el) {
        if (!el) return;
        el.classList.add('value-change');
        setTimeout(() => el.classList.remove('value-change'), 450);
    }

    function cargarRenglones() {
        const tipo = document.getElementById('tipoObra').value;
        const global = parseFloat(document.getElementById('cantidadGlobal').value) || 0;
        const tabla = document.getElementById('cuerpoTabla');
        tabla.innerHTML = "";

        if (!baseDatos[tipo]) return;

        const renglones = baseDatos[tipo];
        renglones.forEach((item, index) => {
            const cantidadInicial = (item.c * global).toFixed(2);
            const subtotalInicial = (parseFloat(cantidadInicial) * (item.p || 0)).toFixed(2);

            tabla.innerHTML += `
            <tr id="fila-${index}">
                <td>${index + 1}</td>
                <td>${item.n}</td>
                <td>${item.u}</td>
                <td>
                    <input type="number" step="0.01"
                           class="input-editable"
                           id="cant-${index}"
                           value="${cantidadInicial}"
                           oninput="recalcularFila(${index})">
                </td>
                <td>
                    <input type="number" step="0.01"
                           class="input-editable"
                           id="precio-${index}"
                           value="${(item.p || 0)}"
                           oninput="recalcularFila(${index})">
                </td>
                <td id="subtotal-${index}" class="subtotal-celda" data-value="${parseFloat(subtotalInicial)}">${formatCurrency(parseFloat(subtotalInicial),2)}</td>
                <td><small>${item.m || ''}</small></td>
            </tr>
            `;
        });

        // Agregar renglones personalizados guardados por tipolog√≠a
        try {
            const customRaw = localStorage.getItem('wm_custom_renglones') || '{}';
            const customObj = JSON.parse(customRaw);
            const arr = (customObj && customObj[tipo]) ? customObj[tipo] : [];
            arr.forEach((it, ci) => {
                const cid = `custom-${ci}-${Date.parse(it.ts || new Date())}`;
                const cantidadInicial = (it.cantidad || (it.c || 0) * global).toFixed(2);
                const subtotalInicial = (parseFloat(cantidadInicial) * (it.precio || 0)).toFixed(2);
                tabla.innerHTML += `
                <tr id="fila-${cid}">
                    <td>--</td>
                    <td>${it.n}</td>
                    <td>${it.u || ''}</td>
                    <td>
                        <input type="number" step="0.01" class="input-editable" id="cant-${cid}" value="${cantidadInicial}" oninput="recalcularFila('${cid}')">
                    </td>
                    <td>
                        <input type="number" step="0.01" class="input-editable" id="precio-${cid}" value="${(it.precio || 0)}" oninput="recalcularFila('${cid}')">
                    </td>
                    <td id="subtotal-${cid}" class="subtotal-celda" data-value="${parseFloat(subtotalInicial)}">${formatCurrency(parseFloat(subtotalInicial),2)}</td>
                    <td><small>${it.m || ''} <button onclick="removeCustomRenglon('${tipo}', ${ci})" style="margin-left:8px;background:#dc3545;color:#fff;border:none;border-radius:4px;padding:4px 6px;">Eliminar</button></small></td>
                </tr>
                `;
            });
        } catch (e) { console.warn('No se cargaron renglones personalizados:', e); }

        // Calcular totales iniciales
        actualizarGranTotal();
    }

    // Recalcula un rengl√≥n cuando cambia cantidad o precio
    function recalcularFila(index) {
        try {
            const cant = parseFloat(document.getElementById(`cant-${index}`).value) || 0;
            const precio = parseFloat(document.getElementById(`precio-${index}`).value) || 0;
            const subtotal = cant * precio;
            const celda = document.getElementById(`subtotal-${index}`);
            if (celda) {
                celda.dataset.value = subtotal;
                celda.innerText = formatCurrency(subtotal,2);
                animateValueChange(celda);
            }
        } catch (e) { console.warn('recalcularFila error:', e); }
        actualizarGranTotal();
    }

    // Suma subtotales y delega a actualizarTotales
    function actualizarGranTotal() {
        let totalDirecto = 0;
        document.querySelectorAll('.subtotal-celda').forEach(celda => {
            // Preferir valor num√©rico limpio almacenado en data-value
            const dv = celda.dataset && celda.dataset.value;
            let valor = 0;
            if (typeof dv !== 'undefined') {
                valor = parseFloat(dv) || 0;
            } else {
                // Fallback: normalizar texto (soporta coma decimal o punto)
                let txt = (celda.innerText || '').replace(/[Q\s\u00A0]/g, '').trim();
                if (txt === '') { valor = 0; }
                else {
                    // Si contiene ambos '.' y ',', asumir '.' miles y ',' decimales
                    if (txt.indexOf('.') !== -1 && txt.indexOf(',') !== -1) {
                        txt = txt.replace(/\./g,'').replace(',', '.');
                    } else if (txt.indexOf(',') !== -1 && txt.indexOf('.') === -1) {
                        txt = txt.replace(/,/g, '.');
                    } else {
                        txt = txt.replace(/,/g, '');
                    }
                    valor = parseFloat(txt) || 0;
                }
            }
            totalDirecto += valor;
        });

        if (window.actualizarTotales) {
            try { window.actualizarTotales(totalDirecto); }
            catch(e) { console.warn('error al llamar actualizarTotales:', e); }
        }
    }

    // Exponer funciones globales para inputs inline
    window.recalcularFila = recalcularFila;
    window.actualizarGranTotal = actualizarGranTotal;

    // Calcula y actualiza los Totales financieros (usa el total directo en Q)
    function actualizarTotales(totalDirecto) {
        totalDirecto = Number(totalDirecto) || 0;
        const costoIndirecto = totalDirecto * 0.15; // 15%
        const costoImprevisto = totalDirecto * 0.05; // 5%
        const costoUtilidad = (totalDirecto + costoIndirecto + costoImprevisto) * 0.12; // 12%
        const precioVentaTotal = totalDirecto + costoIndirecto + costoImprevisto + costoUtilidad;

        const elTotal = document.getElementById('totalCostoDirecto');
        const elIndirecto = document.getElementById('costoIndirecto');
        const elImprev = document.getElementById('costoImprevisto');
        const elUtil = document.getElementById('costoUtilidad');
        const elPrecio = document.getElementById('precioVentaTotal');

        if (elTotal) { elTotal.innerText = formatCurrency(totalDirecto,2); animateValueChange(elTotal); }
        if (elIndirecto) { elIndirecto.innerText = formatCurrency(costoIndirecto,2); animateValueChange(elIndirecto); }
        if (elImprev) { elImprev.innerText = formatCurrency(costoImprevisto,2); animateValueChange(elImprev); }
        if (elUtil) { elUtil.innerText = formatCurrency(costoUtilidad,2); animateValueChange(elUtil); }
        if (elPrecio) { elPrecio.innerText = formatCurrency(precioVentaTotal,2); animateValueChange(elPrecio); }
    }
    window.actualizarTotales = actualizarTotales;

    function calcularTodo() {
        const tipo = document.getElementById('tipoObra').value;
        const global = parseFloat(document.getElementById('cantidadGlobal').value) || 0;
        let totalDirecto = 0;

        if (baseDatos[tipo]) {
            baseDatos[tipo].forEach(item => {
                const cantidad = item.c * global;
                totalDirecto += cantidad * item.p;
            });
        }
        // Delegar render financiero y explosi√≥n de materiales a la funci√≥n central
        if (window.actualizarTotales) {
            try { window.actualizarTotales(totalDirecto); }
            catch(e) { console.warn('actualizarTotales error:', e); }
        } else {
            const costoIndirecto = totalDirecto * 0.15; // 15%
            const costoImprevisto = totalDirecto * 0.05; // 5%
            const costoUtilidad = (totalDirecto + costoIndirecto + costoImprevisto) * 0.12; // 12%
            const precioVentaTotal = totalDirecto + costoIndirecto + costoImprevisto + costoUtilidad;

            document.getElementById('totalCostoDirecto').innerText = `Q ${totalDirecto.toFixed(2)}`;
            document.getElementById('costoIndirecto').innerText = `Q ${costoIndirecto.toFixed(2)}`;
            document.getElementById('costoImprevisto').innerText = `Q ${costoImprevisto.toFixed(2)}`;
            document.getElementById('costoUtilidad').innerText = `Q ${costoUtilidad.toFixed(2)}`;
            document.getElementById('precioVentaTotal').innerText = `Q ${precioVentaTotal.toFixed(2)}`;
        }
    }

    function guardarLocal() {
        const precioEl = document.getElementById('precioVentaTotal');
        const totalDisplay = precioEl ? precioEl.innerText : '';
        const totalNumber = totalDisplay ? parseFloat(totalDisplay.replace(/[^0-9.-]+/g, '')) || 0 : 0;

        // Capturar renglones actuales (cantidad y precio editados)
        const renglonesGuardados = [];
        document.querySelectorAll('#cuerpoTabla tr').forEach(tr => {
            const idx = tr.id ? tr.id.replace('fila-','') : '';
            const tds = tr.querySelectorAll('td');
            const nombre = tds[1] ? tds[1].innerText.trim() : '';
            const unidad = tds[2] ? tds[2].innerText.trim() : '';
            const cantidadInput = tr.querySelector(`#cant-${idx}`);
            const precioInput = tr.querySelector(`#precio-${idx}`);
            const cantidad = cantidadInput ? (parseFloat(cantidadInput.value) || 0) : 0;
            const precio = precioInput ? (parseFloat(precioInput.value) || 0) : 0;
            const subtotal = cantidad * precio;
            renglonesGuardados.push({ index: idx, n: nombre, u: unidad, cantidad, precio, subtotal });
        });

        const data = {
            id: Date.now(),
            nombre: (document.getElementById('nombreProyecto').value || '').toString(),
            tipo: document.getElementById('tipoObra').value,
            m2: document.getElementById('cantidadGlobal').value,
            fecha: new Date().toLocaleDateString(),
            total: totalDisplay,
            totalNumber: totalNumber,
            renglones: renglonesGuardados
        };

        // Guardar en la key 'proyectos'
        let proyectos = JSON.parse(localStorage.getItem('proyectos') || "[]");
        proyectos.push(data);
        localStorage.setItem('proyectos', JSON.stringify(proyectos));

        // Tambi√©n guardar/mergear en 'wm_proyectos' evitando duplicados por nombre|fecha
        try {
            let wm = JSON.parse(localStorage.getItem('wm_proyectos') || "[]");
            const key = (data.nombre || '').toString().trim().toLowerCase() + '|' + (data.fecha || '');
            const exists = wm.some(p => ((p.nombre || '').toString().trim().toLowerCase() + '|' + (p.fecha || '')) === key);
            if (!exists) {
                wm.push(data);
                localStorage.setItem('wm_proyectos', JSON.stringify(wm));
            }
            // Also save a compatible record to WM_PROJECTS_DB so other pages (inicio/proyectos) see it
            try {
                const db = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
                const wmRec = {
                    id: 'PROY-' + Date.now(),
                    cliente: '',
                    proyecto: data.nombre || '',
                    ubi: '',
                    at: '',
                    ac: data.m2 || '',
                    cubierta: data.tipo || '',
                    costo: data.totalNumber || 0,
                    tiempo: '',
                    fecha: data.fecha || '',
                    timestamp: new Date().toISOString()
                };
                const existsB = db.some(p => (p.proyecto || '') === (wmRec.proyecto || '') && (p.fecha || '') === (wmRec.fecha || ''));
                if (!existsB) {
                    db.push(wmRec);
                    localStorage.setItem('WM_PROJECTS_DB', JSON.stringify(db));
                }
            } catch(e) { console.warn('Error guardando en WM_PROJECTS_DB', e); }
        } catch (e) {
            console.warn('Error guardando en wm_proyectos:', e);
        }

        wmToast("Proyecto guardado localmente en SOFTCON DB (incluye cantidades editadas)");
    }

    // Agregar rengl√≥n personalizado (persistente por tipolog√≠a)
    function addCustomRenglon(){
        try{
            const tipo = document.getElementById('tipoObra').value || 'residencial';
            const nombre = prompt('Nombre del rengl√≥n personalizado (p.ej. Rejilla, Malla, Impermeabilizante)') || '';
            if (!nombre) return;
            const unidad = prompt('Unidad (p.ej. m2, m3, unid, ml, saco)') || 'unid';
            const cantidad = parseFloat(prompt('Cantidad estimada (n√∫mero) ‚Äî si desea usar m2*coef deje vac√≠o', '')) || 0;
            const precio = parseFloat(prompt('Precio unitario (Q)', '0')) || 0;

            const raw = localStorage.getItem('wm_custom_renglones') || '{}';
            const obj = JSON.parse(raw);
            obj[tipo] = obj[tipo] || [];
            obj[tipo].push({ n: nombre, u: unidad, cantidad: cantidad, precio: precio, ts: Date.now() });
            localStorage.setItem('wm_custom_renglones', JSON.stringify(obj));
            cargarRenglones();
        }catch(e){ console.warn('addCustomRenglon error', e); wmToast('No fue posible crear el rengl√≥n.'); }
    }

    function removeCustomRenglon(tipo, index){
        try{
            const raw = localStorage.getItem('wm_custom_renglones') || '{}';
            const obj = JSON.parse(raw);
            if (!obj[tipo] || !obj[tipo][index]) return;
            if (!confirm('Eliminar rengl√≥n personalizado?')) return;
            obj[tipo].splice(index,1);
            localStorage.setItem('wm_custom_renglones', JSON.stringify(obj));
            cargarRenglones();
        }catch(e){ console.warn('removeCustomRenglon error', e); }
    }

    // Cargar un proyecto guardado en la UI (restaurar m2, tipo y renglones editados)
    function cargarProyectoEnUI(proyecto) {
        try {
            if (!proyecto) return;
            document.getElementById('nombreProyecto').value = proyecto.nombre || '';
            if (proyecto.tipo) document.getElementById('tipoObra').value = proyecto.tipo;
            if (proyecto.m2) document.getElementById('cantidadGlobal').value = proyecto.m2;
            try {
                const cubEl = document.getElementById('cubiertaProyecto');
                if (cubEl) cubEl.value = proyecto.cubierta || proyecto.tipo_cubierta || proyecto.tipo || '';
            } catch(e) { /* ignore */ }
            // Rebuild table from base and then apply overrides
            cargarRenglones();
            // Aplicar par√°metros regionales si existen en WM_PROJECTS_DB o wm_proyectos
            try { applyParamsToTable(proyecto); } catch(e){ /* ignore */ }
            if (Array.isArray(proyecto.renglones)) {
                proyecto.renglones.forEach(r => {
                    const idx = r.index;
                    const cantEl = document.getElementById(`cant-${idx}`);
                    const precioEl = document.getElementById(`precio-${idx}`);
                    if (cantEl && typeof r.cantidad !== 'undefined') cantEl.value = r.cantidad;
                    if (precioEl && typeof r.precio !== 'undefined') precioEl.value = r.precio;
                    // actualizar subtotal visual
                    try { recalcularFila(idx); } catch(e){}
                });
            }
            // Recalcular totales
            actualizarGranTotal();
        } catch (e) { console.warn('cargarProyectoEnUI error:', e); }
    }

    // Aplica par√°metros (baseCostPerM2, roofMultiplier) a la tabla de renglones escalando precios unitarios
    function applyParamsToTable(projecto) {
        try {
            const name = (projecto.nombre || projecto.proyecto || '').toString();
            if (!name) return;
            // buscar params en WM_PROJECTS_DB, wm_proyectos o proyectos
            const dbA = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
            const dbB = JSON.parse(localStorage.getItem('wm_proyectos') || '[]');
            const dbC = JSON.parse(localStorage.getItem('proyectos') || '[]');
            let found = dbA.find(p => (p && ((p.proyecto || p.id || '') === name || (projecto.id && p.id === projecto.id)))) ||
                        dbB.find(p => (p && ((p.nombre || p.proyecto || '') === name || (projecto.id && p.id === projecto.id)))) ||
                        dbC.find(p => (p && ((p.nombre || p.proyecto || '') === name || (projecto.id && p.id === projecto.id))));
            if (!found) return;
            const params = found.params || (found.params === undefined ? (JSON.parse(localStorage.getItem('WM_PARAMS_DB')||'{}')[found.departamento] || null) : null);
            if (!params) return;

            const area = parseFloat(document.getElementById('cantidadGlobal').value) || 0;

            // Cubierta (fuente: proyecto/visita_campo) ‚Äî coincide con keys de WM_PARAMS_DB
            let cubiertaKey = (
                (projecto && (projecto.cubierta || projecto.tipo_cubierta || '')) ||
                (found && (found.cubierta || found.tipo_cubierta || found.tipo || '')) ||
                ''
            ).toString().toUpperCase().trim();

            // Normalizar a las claves esperadas por DEFAULT_PARAMS
            if (cubiertaKey && params.roofMultiplier && !params.roofMultiplier[cubiertaKey]) {
                if (cubiertaKey.includes('PREFAB')) cubiertaKey = 'LOSA PREFABRICADA';
                else if (cubiertaKey.includes('MACIZ') || cubiertaKey.includes('SOLID') || cubiertaKey.includes('SOLIDA') || cubiertaKey.includes('S√ìL') || cubiertaKey.includes('SOL')) cubiertaKey = 'LOSA SOLIDA';
                else if (cubiertaKey.includes('ESTRUCT')) cubiertaKey = 'ESTRUCTURA METALICA';
                else if (cubiertaKey.includes('PERGOLA')) cubiertaKey = 'PERGOLA';
                else if (cubiertaKey.includes('TEJA')) cubiertaKey = 'TEJA';
            }

            // calcular total directo actual desde baseDatos
            let totalDirectoActual = 0;
            try {
                const tipoKey = document.getElementById('tipoObra').value;
                if (baseDatos[tipoKey]) {
                    baseDatos[tipoKey].forEach(item => { totalDirectoActual += (item.c * area) * (item.p || 0); });
                }
            } catch(e) { console.warn('calc total directo error', e); }

            const base = Number(params.baseCostPerM2) || 0;
            const roofMult = (params.roofMultiplier && cubiertaKey && params.roofMultiplier[cubiertaKey]) ? Number(params.roofMultiplier[cubiertaKey]) : 1;
            const desiredTotalDirect = base * roofMult * area;
            if (!totalDirectoActual || desiredTotalDirect <= 0) return;
            const factor = desiredTotalDirect / totalDirectoActual;

            // Escalar precios en la tabla
            document.querySelectorAll('#cuerpoTabla tr').forEach(tr => {
                const idx = tr.id ? tr.id.replace('fila-','') : '';
                const precioInput = tr.querySelector(`#precio-${idx}`);
                if (precioInput) {
                    const orig = parseFloat(precioInput.value) || 0;
                    precioInput.value = (orig * factor).toFixed(2);
                    try { recalcularFila(idx); } catch(e){}
                }
            });
            wmToast('Se aplicaron par√°metros regionales y se escalaron precios.');
        } catch (e) { console.warn('applyParamsToTable error', e); }
    }

    window.cargarProyectoEnUI = cargarProyectoEnUI;

    function exportCSV() {
        let csv = "No,Rengl√≥n,Unidad,Cantidad,Precio,Subtotal\n";
        const rows = document.querySelectorAll('#cuerpoTabla tr');
        rows.forEach(tr => {
            const idx = tr.id ? tr.id.replace('fila-','') : '';
            const cols = tr.querySelectorAll('td');
            if (!cols || cols.length < 6) return;
            const nombre = cols[1].innerText.trim();
            const unidad = cols[2].innerText.trim();
            const cantidadInput = tr.querySelector(`#cant-${idx}`) || tr.querySelector('td:nth-child(4) input');
            const precioInput = tr.querySelector(`#precio-${idx}`) || tr.querySelector('td:nth-child(5) input');
            const cantidad = cantidadInput ? (parseFloat(cantidadInput.value) || 0) : parseFloat(cols[3].innerText.replace(/Q|\s|,/g,'')) || 0;
            const precio = precioInput ? (parseFloat(precioInput.value) || 0) : parseFloat(cols[4].innerText.replace(/Q|\s|,/g,'')) || 0;
            const subtotal = (cantidad * precio) || 0;
            csv += `${idx || ''},"${nombre}",${unidad},${cantidad},${precio},${subtotal}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'Presupuesto_SOFTCON.csv');
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function exportPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("CONSTRUCTORA WM/M&S", 14, 15);
            doc.text("CONSTRUYENDO EL FUTURO", 14, 22);

            const body = [];
            document.querySelectorAll('#cuerpoTabla tr').forEach(tr => {
                const idx = tr.id ? tr.id.replace('fila-','') : '';
                const nombre = tr.querySelectorAll('td')[1].innerText.trim();
                const unidad = tr.querySelectorAll('td')[2].innerText.trim();
                const cantidad = tr.querySelector(`#cant-${idx}`) ? (parseFloat(tr.querySelector(`#cant-${idx}`).value) || 0) : 0;
                const precio = tr.querySelector(`#precio-${idx}`) ? (parseFloat(tr.querySelector(`#precio-${idx}`).value) || 0) : 0;
                const subtotal = cantidad * precio;
                body.push([idx || '', nombre, unidad, cantidad.toString(), precio.toString(), subtotal.toString()]);
            });

            doc.autoTable({
                startY: 30,
                head: [["No","Rengl√≥n","Unidad","Cantidad","Precio","Subtotal"]],
                body: body
            });
            doc.save("Informe_WM_Construcci√≥n.pdf");
        } catch (e) { console.warn('exportPDF error:', e); }
    }

    // IMPORTAR RENGLONES (JSON o CSV) Y FUSIONAR EN baseDatos (normaliza y evita duplicados)
    function importarRenglones(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = function(e) {
            const contenido = e.target.result;

            // Intentar parsear JSON
            try {
                const parsed = JSON.parse(contenido);
                // parsed puede ser {residencial: [...], ...} o array de items con 'tipo'
                let agrupado = {};
                if (Array.isArray(parsed)) {
                    parsed.forEach(it => {
                        const tipo = (it.tipo || it.t || 'residencial').toString().toLowerCase();
                        if (!agrupado[tipo]) agrupado[tipo] = [];
                        agrupado[tipo].push(it);
                    });
                } else if (typeof parsed === 'object' && parsed !== null) {
                    Object.keys(parsed).forEach(k => {
                        const tipo = k.toLowerCase();
                        agrupado[tipo] = parsed[k];
                    });
                }

                const res = mergeRenglonesIntoBase(agrupado);
                localStorage.setItem(getRenglonesStorageKey(), JSON.stringify(baseDatos));
                exportMergedBase();
                wmToast(`Importaci√≥n completada: a√±adidos ${res.added}, omitidos ${res.skipped}`);
                cargarRenglones();
                return;
            } catch (err) {
                // no es JSON v√°lido ‚Äî intentar CSV
            }

            // Intentar parsear CSV flexible
            const lines = contenido.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
            if (lines.length === 0) { wmToast('Archivo vac√≠o'); return; }
            const header = lines[0].split(',').map(h => h.trim().toLowerCase());
            const colsIndex = (name) => header.findIndex(h => h.indexOf(name) !== -1);

            const tipoIdx = colsIndex('tipo') >= 0 ? colsIndex('tipo') : colsIndex('categoria');
            const nombreIdx = colsIndex('n') >= 0 ? colsIndex('n') : (colsIndex('nombre') >= 0 ? colsIndex('nombre') : 0);
            const unidadIdx = colsIndex('u') >= 0 ? colsIndex('u') : colsIndex('unidad');
            const cIdx = colsIndex('c') >= 0 ? colsIndex('c') : (colsIndex('r') >= 0 ? colsIndex('r') : colsIndex('coef'));
            const pIdx = colsIndex('p') >= 0 ? colsIndex('p') : (colsIndex('precio') >= 0 ? colsIndex('precio') : colsIndex('price'));
            const mIdx = colsIndex('m') >= 0 ? colsIndex('m') : colsIndex('material');

            let agrupado = {};
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                const tipo = (tipoIdx >= 0 && parts[tipoIdx]) ? parts[tipoIdx].trim().toLowerCase() : 'residencial';
                const nombre = parts[nombreIdx] ? parts[nombreIdx].trim() : '';
                if (!nombre) continue;
                const item = {
                    n: nombre,
                    u: (unidadIdx >= 0 && parts[unidadIdx]) ? parts[unidadIdx].trim() : '',
                    c: parseFloat((cIdx >= 0 && parts[cIdx]) ? parts[cIdx] : 1) || 1,
                    p: parseFloat((pIdx >= 0 && parts[pIdx]) ? parts[pIdx] : 0) || 0,
                    m: (mIdx >= 0 && parts[mIdx]) ? parts[mIdx].trim() : ''
                };
                if (!agrupado[tipo]) agrupado[tipo] = [];
                agrupado[tipo].push(item);
            }

            const res = mergeRenglonesIntoBase(agrupado);
            localStorage.setItem(getRenglonesStorageKey(), JSON.stringify(baseDatos));
            exportMergedBase();
            wmToast(`Importaci√≥n completada: a√±adidos ${res.added}, omitidos ${res.skipped}`);
            cargarRenglones();
        };

        reader.readAsText(file);
    }

    function mergeRenglonesIntoBase(agrupado) {
        const tiposValidos = ['residencial','comercial','industrial','civil','publica'];
        let added = 0, skipped = 0;
        Object.keys(agrupado).forEach(tipoRaw => {
            const tipo = tipoRaw.toLowerCase();
            if (!tiposValidos.includes(tipo)) return;
            baseDatos[tipo] = baseDatos[tipo] || [];
            const existentes = new Set(baseDatos[tipo].map(it => (it.n || '').toString().trim().toLowerCase()));

            (agrupado[tipo] || []).forEach(it => {
                const name = (it.n || it.nombre || it.name || '').toString().trim();
                if (!name) return;
                const norm = name.toLowerCase();
                if (existentes.has(norm)) { skipped++; return; }
                const newItem = {
                    n: name,
                    u: it.u || it.unidad || it.unit || '',
                    c: parseFloat(it.c || it.r || it.coef || 1) || 1,
                    p: parseFloat(it.p || it.precio || it.price || 0) || 0,
                    m: it.m || it.materiales || it.material || ''
                };
                baseDatos[tipo].push(newItem);
                existentes.add(norm);
                added++;
            });
        });
        return { added, skipped };
    }

    // EXPORTAR baseDatos fusionado a JSON (descarga autom√°tica)
    function exportMergedBase() {
        try {
            const data = JSON.stringify(baseDatos, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'baseDatos_fusionado.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } catch (e) {
            console.warn('Error al exportar baseDatos fusionado:', e);
        }
    }

    // Toggle compact view for table (persists choice)
    function toggleCompactView() {
        const tbl = document.getElementById('tablaPresupuesto');
        const btn = document.getElementById('compactToggle');
        if (!tbl) return;
        tbl.classList.toggle('compact-view');
        if (btn) btn.classList.toggle('active');
        try { localStorage.setItem('calc_compact_view', tbl.classList.contains('compact-view') ? '1' : '0'); } catch(e) {}
    }

    // Apply persisted compact view on load
    try {
        if (localStorage.getItem('calc_compact_view') === '1') {
            const t = document.getElementById('tablaPresupuesto');
            const b = document.getElementById('compactToggle');
            if (t) t.classList.add('compact-view');
            if (b) b.classList.add('active');
        }
    } catch(e) {}

    // Observe newly added tables and apply compact-view if user preference is set
    (function observeTablesForCompactCalc(){
        try{
            const enabled = localStorage.getItem('calc_compact_view') === '1';
            if (!enabled) return;
            const applyToNode = (node) => {
                if (!node) return;
                if (node.tagName === 'TABLE') node.classList.add('compact-view');
                if (node.querySelectorAll) {
                    node.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
                }
            };
            // apply to existing
            document.querySelectorAll('table').forEach(t=>t.classList.add('compact-view'));
            const mo = new MutationObserver(muts=>{
                muts.forEach(m=>{
                    m.addedNodes && m.addedNodes.forEach(n=>{ if (n.nodeType===1) applyToNode(n); });
                });
            });
            mo.observe(document.body, { childList: true, subtree: true });
        } catch(e) { /* ignore */ }
    })();

    // FUNCI√ìN PARA IMPORTAR Y SINCRONIZAR
    function importarCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = function(e) {
            const contenido = e.target.result;
            const lineas = contenido.split('\n');
            
            // Verificamos si es un archivo de proyecto o un informe de materiales
            if (lineas[0] && lineas[0].includes("ID,Nombre,Tipo,M2,Fecha")) {
                // Es un archivo de BASE DE DATOS de proyectos
                let proyectosNuevos = [];
                for (let i = 1; i < lineas.length; i++) {
                    const datos = lineas[i].split(',');
                    if (datos.length >= 5) {
                        proyectosNuevos.push({
                            id: datos[0],
                            nombre: datos[1],
                            tipo: datos[2],
                            m2: datos[3],
                            fecha: datos[4]
                        });
                    }
                }
                
                // Fusionar con los existentes evitando duplicados por ID
                let proyectosActuales = JSON.parse(localStorage.getItem('proyectos') || "[]");
                const idsExistentes = new Set(proyectosActuales.map(p => p.id.toString()));
                
                proyectosNuevos.forEach(p => {
                    if (!idsExistentes.has(p.id.toString())) {
                        proyectosActuales.push(p);
                    }
                });

                localStorage.setItem('proyectos', JSON.stringify(proyectosActuales));
                wmToast("¬°Sincronizaci√≥n Exitosa! Los proyectos han sido integrados.");
                window.location.href = 'proyectos.html';
            } else {
                wmToast("Error: El archivo no tiene el formato de base de datos de Proyectos WM.");
            }
        };
        reader.readAsText(file);
    }

    // MODIFICACI√ìN DE EXPORTAR CSV PARA BASE DE DATOS (Sincronizaci√≥n)
    function exportarBaseDatos() {
        let proyectos = JSON.parse(localStorage.getItem('proyectos') || "[]");
        let csv = "ID,Nombre,Tipo,M2,Fecha\n";
        
        proyectos.forEach(p => {
            csv += `${p.id},${p.nombre},${p.tipo},${p.m2},${p.fecha}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'DB_RESPALDO_WM.csv');
        a.click();
    }

    // Sincronizar proyectos entre claves locales y evitar duplicados
    function syncProyectosToWm() {
        try {
            const from = JSON.parse(localStorage.getItem('proyectos') || "[]");
            if (!Array.isArray(from) || from.length === 0) return 0;
            const to = JSON.parse(localStorage.getItem('wm_proyectos') || "[]");
            const map = new Map();
            to.forEach(p => {
                const key = (p && p.nombre ? p.nombre.toString().trim().toLowerCase() : '') + '|' + (p && p.fecha ? p.fecha.toString().trim() : '');
                map.set(key, true);
            });
            let added = 0;
            from.forEach(p => {
                const key = (p && p.nombre ? p.nombre.toString().trim().toLowerCase() : '') + '|' + (p && p.fecha ? p.fecha.toString().trim() : '');
                if (!map.has(key)) {
                    to.push(p);
                    map.set(key, true);
                    added++;
                }
            });
            if (added > 0) {
                localStorage.setItem('wm_proyectos', JSON.stringify(to));
            }
            // Marcar migraci√≥n con timestamp (informativo)
            localStorage.setItem('WM_PROJECTS_MIGRATED_AT', new Date().toISOString());
            return added;
        } catch (e) {
            console.warn('Error sincronizando proyectos:', e);
            return 0;
        }
    }

    window.onload = function() {
        try {
            const added = syncProyectosToWm();
            if (added > 0) console.info(`Sincronizados ${added} proyectos desde 'proyectos' a 'wm_proyectos'.`);
            try { loadProjectsForCalculadora(); } catch(e) {}
        } catch(e) { console.warn(e); }
        cargarRenglones();
    };

    // Si un proyecto fue seleccionado desde la lista de proyectos, cargarlo y eliminar la selecci√≥n
    try {
        window.addEventListener('load', () => {
            try {
                const raw = localStorage.getItem('WM_SELECTED_PROJECT');
                if (raw) {
                    const p = JSON.parse(raw);
                    if (p && typeof window.cargarProyectoEnUI === 'function') {
                        window.cargarProyectoEnUI(p);
                    }
                    localStorage.removeItem('WM_SELECTED_PROJECT');
                }
                // tambi√©n manejar WM_OPEN_PROJECT (enviado desde visita_campo o proyectos)
                try {
                    const rawOpen = localStorage.getItem('WM_OPEN_PROJECT');
                    if (rawOpen) {
                        const op = JSON.parse(rawOpen);
                        if (op) {
                            // intentar buscar renglones completos por nombre en 'proyectos' si existe
                            let full = null;
                            try { full = (JSON.parse(localStorage.getItem('proyectos')||'[]')).find(x => x.nombre === (op.proyecto || op.nombre)); } catch(e){}
                            if (full && typeof window.cargarProyectoEnUI === 'function') window.cargarProyectoEnUI(full);
                            else if (typeof window.cargarProyectoEnUI === 'function') {
                                // apply basic fields (no confundir cubierta con tipolog√≠a)
                                window.cargarProyectoEnUI({
                                    nombre: op.proyecto || op.nombre || '',
                                    tipo: op.tipoObra || op.tipologia || '',
                                    m2: op.ac || op.m2 || '',
                                    cubierta: op.cubierta || op.tipo || ''
                                });
                            }
                        }
                        localStorage.removeItem('WM_OPEN_PROJECT');
                    }
                } catch(e) { console.warn('Error applying WM_OPEN_PROJECT', e); }
            } catch (e) { console.warn('Error aplicando WM_SELECTED_PROJECT:', e); }
        });
    } catch (e) { /* ignore */ }

    // Cargar lista de proyectos en el selector de Calculadora
    function loadProjectsForCalculadora(){
        const dbA = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
        const dbB = JSON.parse(localStorage.getItem('wm_proyectos') || '[]');
        const dbC = JSON.parse(localStorage.getItem('proyectos') || '[]');
        const merged = [];
        (dbA||[]).forEach(p=> merged.push({ id: p.id || p.proyecto, nombre: p.proyecto || p.id, m2: p.ac || p.m2 || '' }));
        (dbB||[]).forEach(p=> merged.push({ id: p.nombre || p.id, nombre: p.nombre || p.proyecto, m2: p.m2 || p.ac || '' }));
        (dbC||[]).forEach(p=> merged.push({ id: p.id || p.nombre, nombre: p.nombre || p.proyecto, m2: p.m2 || p.m2 || '' }));
        // dedupe by nombre
        const map = {};
        merged.forEach(it=>{ if(it.nombre) map[it.nombre]=it; });
        const final = Object.values(map);
        const sel = document.getElementById('calcProjectSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- Seleccione --</option>' + final.map(p=>`<option value="${p.nombre}">${p.nombre}${p.m2? ' - '+p.m2+' m¬≤':''}</option>`).join('');

        // Auto-abrir al seleccionar (evita clic extra)
        try {
            if (!sel.dataset.wmBound) {
                sel.addEventListener('change', () => {
                    if (sel.value) openSelectedProjectInUI();
                });
                sel.dataset.wmBound = '1';
            }
        } catch(e) { /* ignore */ }
    }

    function findProjectAny(name){
        if (!name) return null;
        // Preferir WM_PROJECTS_DB (visita_campo)
        const dbA = JSON.parse(localStorage.getItem('WM_PROJECTS_DB') || '[]');
        const a = (dbA||[]).find(x => x && ((x.proyecto || x.id || '') == name));
        if (a) {
            return {
                source: 'WM_PROJECTS_DB',
                raw: a,
                ui: {
                    nombre: a.proyecto || a.id || name,
                    tipo: a.tipoObra || a.tipologia || '',
                    m2: a.ac || a.m2 || '',
                    cubierta: a.cubierta || a.tipo || a.tipo_cubierta || '',
                    renglones: a.renglones || undefined
                }
            };
        }

        const dbB = JSON.parse(localStorage.getItem('wm_proyectos') || '[]');
        const b = (dbB||[]).find(x => x && ((x.nombre || x.proyecto || x.id || '') == name));
        if (b) {
            return {
                source: 'wm_proyectos',
                raw: b,
                ui: {
                    nombre: b.nombre || b.proyecto || name,
                    tipo: b.tipo || '',
                    m2: b.m2 || b.ac || b.totalNumber || '',
                    cubierta: b.cubierta || b.tipo || '',
                    renglones: b.renglones || undefined
                }
            };
        }

        const dbC = JSON.parse(localStorage.getItem('proyectos') || '[]');
        const c = (dbC||[]).find(x => x && ((x.nombre || x.proyecto || x.id || '') == name));
        if (c) {
            return {
                source: 'proyectos',
                raw: c,
                ui: {
                    nombre: c.nombre || c.proyecto || name,
                    tipo: c.tipo || '',
                    m2: c.m2 || c.ac || '',
                    cubierta: c.cubierta || c.tipo || '',
                    renglones: c.renglones || undefined
                }
            };
        }

        return null;
    }

    function injectSelectedProjectM2(){
        const sel = document.getElementById('calcProjectSelect');
        if (!sel || !sel.value) { wmToast('Seleccione un proyecto'); return; }
        const name = sel.value;
        const found = findProjectAny(name);
        if (!found) { wmToast('No se encontr√≥ informaci√≥n del proyecto seleccionado'); return; }
        const p = found.raw || {};
        if (p.ac || p.m2) document.getElementById('cantidadGlobal').value = p.ac || p.m2;
        if (p.proyecto || p.nombre) document.getElementById('nombreProyecto').value = p.proyecto || p.nombre;
        try {
            const cubEl = document.getElementById('cubiertaProyecto');
            if (cubEl) cubEl.value = p.cubierta || p.tipo || '';
        } catch(e) {}
        try { localStorage.setItem('WM_OPEN_PROJECT', JSON.stringify(Object.assign({ proyecto: (p.proyecto || p.nombre || name) }, p))); } catch(e) {}
        cargarRenglones();
    }

    function openSelectedProjectInUI(){
        const sel = document.getElementById('calcProjectSelect');
        if (!sel || !sel.value) { wmToast('Seleccione un proyecto'); return; }
        const name = sel.value;
        const found = findProjectAny(name);
        if (!found) { wmToast('No hay datos para abrir este proyecto en la calculadora'); return; }

        // Persistir WM_OPEN_PROJECT para que app.js resuelva cubierta/losa/techo en explosi√≥n
        try { localStorage.setItem('WM_OPEN_PROJECT', JSON.stringify(Object.assign({ proyecto: found.ui.nombre }, found.raw || {}))); } catch(e) {}

        // Cargar en UI y recalcular
        if (typeof window.cargarProyectoEnUI === 'function') {
            window.cargarProyectoEnUI(found.ui);
        } else {
            wmToast('No est√° disponible cargarProyectoEnUI');
        }
    }
</script>
<script>
    // Generar Orden de Compra t√©cnica desde la App y abrir la plantilla para imprimir/enviar
    function generarOrdenCompra(){
        try{
            const proveedor = prompt('Nombre del proveedor / marca (opcional):','') || '';
            const proyecto = document.getElementById('nombreProyecto').value || 'Proyecto WM';
            const tipo = document.getElementById('tipoObra').value || 'residencial';
            const m2 = parseFloat(document.getElementById('cantidadGlobal').value) || 0;
            const ordenId = 'WM-2026-' + Date.now();

            let items = [];
            // Preferir la funci√≥n de explosi√≥n de materiales si est√° disponible
            if (typeof window.calcularExplosionMateriales === 'function'){
                const expl = window.calcularExplosionMateriales(m2, tipo) || {};
                Object.keys(expl).forEach(k => {
                    const qty = expl[k];
                    if (!qty || qty === 0) return;
                    // heur√≠stica para unidad
                    let unidad = 'un';
                    const kn = k.toString().toLowerCase();
                    if (kn.includes('saco') || kn.includes('cement')) unidad = 'sacos';
                    else if (kn.includes('qq') || kn.includes('hierro')) unidad = 'qq';
                    else if (kn.includes('m3') || kn.includes('arena') || kn.includes('piedrin')) unidad = 'm3';
                    else if (kn.includes('millar') || kn.includes('millares') || kn.includes('block')) unidad = 'millares';

                    items.push({ cantidad: Number(qty), unidad: unidad, descripcion: k, marca: '', precio: 0, subtotal: 0 });
                });
            }

            // Fallback: si no hay items, tomar algunos renglones visibles del presupuesto
            if (items.length === 0){
                document.querySelectorAll('#cuerpoTabla tr').forEach(tr => {
                    const idx = tr.id ? tr.id.replace('fila-','') : '';
                    const nombre = tr.querySelectorAll('td')[1] ? tr.querySelectorAll('td')[1].innerText : '';
                    const unidad = tr.querySelectorAll('td')[2] ? tr.querySelectorAll('td')[2].innerText : '';
                    const cantidadInput = tr.querySelector(`#cant-${idx}`);
                    const cantidad = cantidadInput ? (parseFloat(cantidadInput.value) || 0) : 0;
                    if (cantidad > 0) items.push({ cantidad, unidad: unidad || 'un', descripcion: nombre, marca: '', precio: 0, subtotal: 0 });
                });
            }

            const order = { id: ordenId, fecha: new Date().toLocaleDateString(), proveedor, proyecto, tipo, m2, items, total: 0 };
            localStorage.setItem('WM_PENDING_ORDER', JSON.stringify(order));
            // Abrir plantilla en nueva pesta√±a para revisi√≥n/imprimir
            window.open('orden_compra_tecnica.html','_blank');
        }catch(e){ console.warn('generarOrdenCompra error', e); wmToast('No fue posible generar la orden. Revisa la consola.'); }
    }
</script>
<!-- Registrar service worker al cargar la p√°gina (mejor para instalaci√≥n en m√≥viles) -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW registration failed:', err));
        });
    }
</script>

<script src="app.js"></script>

<!-- Registrar service worker al cargar la p√°gina (mejor para instalaci√≥n en m√≥viles) -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const reg = await navigator.serviceWorker.register('./sw.js');
                console.info('Service Worker registrado:', reg.scope);

                if (reg.waiting) {
                    console.info('Service Worker esperando activaci√≥n (hay nueva versi√≥n).');
                    // opcional: notificar al usuario que recargue para aplicar nueva versi√≥n
                }

                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    console.info('Nueva versi√≥n de SW detectada. Estado:', newWorker.state);
                    newWorker.addEventListener('statechange', () => {
                        console.info('SW state:', newWorker.state);
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Aplicar la nueva versi√≥n autom√°ticamente: solicitar skipWaiting
                            const waitingWorker = reg.waiting || newWorker;
                            if (waitingWorker && waitingWorker.postMessage) {
                                waitingWorker.postMessage({ action: 'skipWaiting' });
                                navigator.serviceWorker.addEventListener('controllerchange', () => {
                                    // el controlador cambi√≥ -> recargar para usar la nueva versi√≥n
                                    location.reload();
                                });
                            }
                        }
                    });
                });
            } catch (err) {
                console.warn('Fallo al registrar el Service Worker:', err);
            }
        });
    }
</script>

</body>
</html>